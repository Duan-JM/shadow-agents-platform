# 阶段一：Dify 项目架构分析

## 目标
深入理解 Dify 项目的整体架构、技术栈和核心功能模块，为后续复刻工作打下基础。

---

## 分析思路

### 1. 整体架构识别
- 识别项目的主要组成部分（前端、后端、数据库、中间件等）
- 理解各部分之间的通信方式和依赖关系
- 绘制系统架构图

### 2. 技术栈分析
- 后端技术栈
- 前端技术栈
- 数据存储方案
- 部署和运维工具

### 3. 功能模块梳理
- 核心业务功能
- 用户管理和认证
- AI 模型集成
- 工作流引擎
- 数据管理

---

## 详细执行步骤

### 步骤 1：后端架构分析

#### 1.1 目录结构分析
```
api/
├── app.py                    # 应用入口文件
├── app_factory.py            # Flask 应用工厂
├── dify_app.py              # Dify 核心应用
├── configs/                  # 配置模块
├── controllers/              # 控制器层（路由处理）
├── core/                     # 核心业务逻辑
├── models/                   # 数据模型（ORM）
├── services/                 # 服务层
├── repositories/             # 数据访问层
├── extensions/               # 扩展模块
├── libs/                     # 工具库
├── tasks/                    # 异步任务（Celery）
├── migrations/               # 数据库迁移
└── tests/                    # 测试代码
```

**分析重点**：
- 📋 **控制器层**：识别所有 API 端点和路由定义
- 🔧 **核心业务**：理解工作流、模型调用、文档处理等核心逻辑
- 💾 **数据模型**：梳理所有数据表结构和关系
- ⚙️ **服务层**：理解各服务模块的职责划分
- 🔌 **扩展模块**：了解第三方集成和插件机制

#### 1.2 技术栈识别
**执行动作**：
```bash
# 查看依赖文件
cat reference_repos/dify/api/pyproject.toml
```

**预期发现**：
- 🐍 Python 3.11+
- 🌶️ Flask（Web 框架）
- 🗃️ SQLAlchemy（ORM）
- 📮 Celery（异步任务）
- 🔒 各类 AI SDK（OpenAI、Anthropic 等）

#### 1.3 核心模块分析
**需要深入理解的模块**：

1. **认证和授权** (`controllers/console/auth/`)
   - 用户登录、注册
   - Token 管理
   - 权限控制

2. **应用管理** (`core/app/`)
   - 应用创建和配置
   - 工作流设计
   - 模型调用逻辑

3. **文档处理** (`core/rag/`)
   - 文档上传和解析
   - 向量化处理
   - 知识库管理

4. **模型集成** (`core/model_runtime/`)
   - 多模型提供商支持
   - 统一调用接口
   - 响应流处理

---

### 步骤 2：前端架构分析

#### 2.1 目录结构分析
```
web/
├── app/                      # Next.js 应用目录
│   ├── (commonLayout)/      # 通用布局
│   ├── components/          # 公共组件
│   ├── install/             # 安装向导
│   └── signin/              # 登录页面
├── assets/                   # 静态资源
├── context/                  # React Context
├── hooks/                    # 自定义 Hooks
├── i18n/                     # 国际化
├── models/                   # 数据模型
├── service/                  # API 服务
├── types/                    # TypeScript 类型
└── utils/                    # 工具函数
```

**分析重点**：
- 🎨 **组件库**：识别可复用的 UI 组件
- 🔌 **API 集成**：理解前后端数据交互
- 🌍 **国际化**：了解多语言支持机制
- 🎭 **状态管理**：Context 和其他状态管理方案

#### 2.2 技术栈识别
**执行动作**：
```bash
# 查看依赖文件
cat reference_repos/dify/web/package.json
```

**预期发现**：
- ⚛️ React 18+
- 🔼 Next.js 14+
- 📘 TypeScript
- 🎨 Tailwind CSS
- 📦 各类 UI 库和工具

#### 2.3 页面和功能分析
**主要页面**：
1. 登录/注册页面
2. 工作台（应用列表）
3. 应用编辑器
4. 工作流设计器
5. 知识库管理
6. 模型配置
7. 日志和监控

---

### 步骤 3：数据存储分析

#### 3.1 数据库设计
**执行动作**：
```bash
# 查看数据库迁移文件
ls -la reference_repos/dify/api/migrations/versions/
```

**分析重点**：
- 📊 **核心表结构**：用户、应用、工作流、文档等
- 🔗 **表关系**：外键、索引、约束
- 📈 **数据增长**：理解哪些表数据量大

#### 3.2 存储方案
**需要分析**：
- PostgreSQL（主数据库）
- Redis（缓存和队列）
- 向量数据库（Qdrant/Weaviate/Milvus）
- 对象存储（S3/MinIO）

---

### 步骤 4：部署架构分析

#### 4.1 Docker 配置分析
**执行动作**：
```bash
# 查看 Docker Compose 配置
cat reference_repos/dify/docker/docker-compose.yaml
```

**识别的服务**：
- ✅ API 服务
- ✅ Worker 服务（Celery）
- ✅ Web 服务
- ✅ Nginx（反向代理）
- ✅ PostgreSQL
- ✅ Redis
- ✅ 向量数据库
- ✅ 其他中间件

#### 4.2 部署流程
**分析要点**：
1. 环境变量配置
2. 服务启动顺序
3. 数据持久化
4. 网络配置
5. 健康检查

---

### 步骤 5：核心功能梳理

#### 5.1 用户和认证系统
- 用户注册/登录
- OAuth 集成
- 租户隔离（多租户支持）
- API Key 管理

#### 5.2 应用系统
- 聊天助手
- 文本生成
- Agent
- 工作流

#### 5.3 工作流引擎
- 节点类型（LLM、条件、循环等）
- 数据流转
- 变量管理
- 调试功能

#### 5.4 知识库系统
- 文档上传
- 文本分段
- 向量化
- 检索增强（RAG）

#### 5.5 模型管理
- 多提供商支持
- 模型配置
- 费用追踪
- 性能监控

---

## 输出产物

完成本阶段后，应该产出以下文档：

### 1. 架构图
```
docs/architecture/
├── system-architecture.md      # 系统整体架构图
├── backend-structure.md        # 后端模块结构图
├── frontend-structure.md       # 前端组件结构图
├── database-schema.md          # 数据库 ER 图
└── deployment-diagram.md       # 部署架构图
```

### 2. 技术栈清单
```markdown
# 技术栈清单

## 后端
- Python 3.11+
- Flask 3.1.2
- SQLAlchemy
- Celery
- ...（详细列出所有重要依赖）

## 前端
- React 18+
- Next.js 14+
- TypeScript
- Tailwind CSS
- ...（详细列出所有重要依赖）

## 基础设施
- PostgreSQL 15+
- Redis 7+
- Nginx
- Docker
```

### 3. 功能模块清单
```markdown
# 功能模块清单

## 核心功能
1. 用户认证系统
   - 邮箱注册登录
   - OAuth 登录
   - API Key 管理
   
2. 应用管理
   - 聊天助手
   - 文本生成
   - Agent
   - 工作流
   
...（详细列出所有功能模块）
```

### 4. API 端点清单
```markdown
# API 端点清单

## 认证相关
- POST /api/login
- POST /api/logout
- POST /api/register
...

## 应用相关
- GET /api/apps
- POST /api/apps
- PUT /api/apps/:id
...
```

---

## 关键问题和决策点

在分析过程中需要明确的问题：

### 🤔 问题 1：保留哪些功能？
- **决策**：是完整复刻还是只复刻核心功能？
- **建议**：先实现核心功能（认证、应用、工作流、知识库），其他功能可后续迭代
- **结论**：先实现核心功能（认证、应用、工作流、知识库），其他功能后续再说

### 🤔 问题 2：简化部署的程度？
- **决策**：Docker Compose 是否足够？是否需要 K8s？
- **建议**：优先支持 Docker Compose，提供单机部署方案
- **结论**：优先支持 Docker compose 部署，不考虑 K8s

### 🤔 问题 3：数据库选择？
- **决策**：是否必须用 PostgreSQL？能否支持其他数据库？
- **建议**：保持 PostgreSQL 作为主数据库，简化配置
- **结论**：保持 PostgreSQL 作为主数据库，简化配置。同时不需要兼容别的数据库

### 🤔 问题 4：向量数据库选择？
- **决策**：支持哪些向量数据库？
- **建议**：优先支持一种（如 Qdrant），后续可扩展
- **结论**：优先支持 milvus，后续再扩展

## 下一步

完成架构分析后，基于分析结果进入：
👉 **阶段二：创建项目基础结构**
