# é˜¶æ®µä¸‰ï¼šå¤åˆ» API åç«¯æ ¸å¿ƒåŠŸèƒ½

## ç›®æ ‡
é‡å†™ Dify çš„ API åç«¯ï¼Œå®ç°æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€åº”ç”¨ç®¡ç†ã€å·¥ä½œæµå¼•æ“ã€çŸ¥è¯†åº“ç³»ç»Ÿç­‰ã€‚æ‰€æœ‰ä»£ç æ³¨é‡Šä½¿ç”¨ä¸­æ–‡ï¼Œç§»é™¤åŸä½œè€…ä¿¡æ¯ã€‚

---

## æ€»ä½“æ€è·¯

### å®ç°ç­–ç•¥
1. **è‡ªåº•å‘ä¸Š**ï¼šå…ˆå®ç°åŸºç¡€å±‚ï¼ˆæ•°æ®æ¨¡å‹ã€å·¥å…·åº“ï¼‰ï¼Œå†å®ç°ä¸šåŠ¡å±‚
2. **æ¨¡å—åŒ–å¼€å‘**ï¼šæ¯ä¸ªæ¨¡å—ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
3. **å‚è€ƒä¸æŠ„è¢­**ï¼šç†è§£åŸç†åé‡æ–°å®ç°ï¼Œä¸ç›´æ¥å¤åˆ¶ä»£ç 
4. **ç®€åŒ–ä¼˜å…ˆ**ï¼šå»é™¤éæ ¸å¿ƒåŠŸèƒ½ï¼Œä¿æŒä»£ç ç®€æ´

### å¼€å‘é¡ºåº
```
æ•°æ®æ¨¡å‹å±‚ â†’ æ•°æ®è®¿é—®å±‚ â†’ æœåŠ¡å±‚ â†’ æ§åˆ¶å™¨å±‚ â†’ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
```

---

## è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1ï¼šæ­å»ºåŸºç¡€è®¾æ–½

#### 1.1 é…ç½®ç®¡ç†æ¨¡å—

**`api/configs/app_config.py`**
```python
"""
åº”ç”¨é…ç½®æ¨¡å—
é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹
"""
import os
from typing import Optional

class Config:
    """åº”ç”¨åŸºç¡€é…ç½®"""
    
    # åº”ç”¨ä¿¡æ¯
    APP_NAME = "Shadow Agents Platform"
    APP_VERSION = "0.1.0"
    
    # Flask é…ç½®
    SECRET_KEY = os.getenv("SECRET_KEY", "change-this-secret-key-in-production")
    DEBUG = os.getenv("DEBUG", "False").lower() == "true"
    
    # æ•°æ®åº“é…ç½®
    SQLALCHEMY_DATABASE_URI = os.getenv(
        "DATABASE_URL",
        "postgresql://shadow:shadow123456@localhost:5432/shadow_agents"
    )
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SQLALCHEMY_ECHO = DEBUG
    
    # Redis é…ç½®
    REDIS_URL = os.getenv("REDIS_URL", "redis://:shadow123456@localhost:6379/0")
    
    # Celery é…ç½®
    CELERY_BROKER_URL = os.getenv("CELERY_BROKER_URL", REDIS_URL)
    CELERY_RESULT_BACKEND = CELERY_BROKER_URL
    
    # æ–‡ä»¶å­˜å‚¨é…ç½®
    STORAGE_TYPE = os.getenv("STORAGE_TYPE", "local")  # local, s3, minio
    STORAGE_LOCAL_PATH = os.getenv("STORAGE_LOCAL_PATH", "./storage")
    
    # JWT é…ç½®
    JWT_SECRET_KEY = SECRET_KEY
    JWT_ACCESS_TOKEN_EXPIRES = int(os.getenv("JWT_ACCESS_TOKEN_EXPIRES", "3600"))  # 1å°æ—¶
    JWT_REFRESH_TOKEN_EXPIRES = int(os.getenv("JWT_REFRESH_TOKEN_EXPIRES", "2592000"))  # 30å¤©
    
    # CORS é…ç½®
    CORS_ALLOW_ORIGINS = os.getenv("CORS_ALLOW_ORIGINS", "*").split(",")
    
    # æ—¥å¿—é…ç½®
    LOG_LEVEL = os.getenv("LOG_LEVEL", "INFO")
    LOG_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"


class DevelopmentConfig(Config):
    """å¼€å‘ç¯å¢ƒé…ç½®"""
    DEBUG = True


class ProductionConfig(Config):
    """ç”Ÿäº§ç¯å¢ƒé…ç½®"""
    DEBUG = False


# æ ¹æ®ç¯å¢ƒå˜é‡é€‰æ‹©é…ç½®
config_map = {
    "development": DevelopmentConfig,
    "production": ProductionConfig,
}

def get_config() -> Config:
    """è·å–å½“å‰ç¯å¢ƒé…ç½®"""
    env = os.getenv("FLASK_ENV", "development")
    return config_map.get(env, DevelopmentConfig)
```

#### 1.2 æ•°æ®åº“æ‰©å±•åˆå§‹åŒ–

**`api/extensions/ext_database.py`**
```python
"""
æ•°æ®åº“æ‰©å±•
åˆå§‹åŒ– SQLAlchemy
"""
from flask_sqlalchemy import SQLAlchemy

# åˆ›å»º SQLAlchemy å®ä¾‹
db = SQLAlchemy()

def init_app(app):
    """
    åˆå§‹åŒ–æ•°æ®åº“æ‰©å±•
    
    Args:
        app: Flask åº”ç”¨å®ä¾‹
    """
    db.init_app(app)
```

#### 1.3 Redis æ‰©å±•

**`api/extensions/ext_redis.py`**
```python
"""
Redis æ‰©å±•
ç”¨äºç¼“å­˜å’Œé˜Ÿåˆ—
"""
import redis
from flask import Flask

# Redis è¿æ¥æ± 
redis_client: redis.Redis = None

def init_app(app: Flask):
    """
    åˆå§‹åŒ– Redis è¿æ¥
    
    Args:
        app: Flask åº”ç”¨å®ä¾‹
    """
    global redis_client
    
    redis_url = app.config.get("REDIS_URL")
    redis_client = redis.from_url(redis_url, decode_responses=True)
    
    # æµ‹è¯•è¿æ¥
    try:
        redis_client.ping()
        app.logger.info("Redis è¿æ¥æˆåŠŸ")
    except Exception as e:
        app.logger.error(f"Redis è¿æ¥å¤±è´¥: {str(e)}")
        raise
```

---

### æ­¥éª¤ 2ï¼šå®ç°æ•°æ®æ¨¡å‹å±‚

#### 2.1 åŸºç¡€æ¨¡å‹ç±»

**`api/models/base.py`**
```python
"""
åŸºç¡€æ•°æ®æ¨¡å‹
æ‰€æœ‰æ¨¡å‹çš„çˆ¶ç±»
"""
from datetime import datetime
from extensions.ext_database import db

class BaseModel(db.Model):
    """
    åŸºç¡€æ¨¡å‹ç±»
    æä¾›é€šç”¨å­—æ®µå’Œæ–¹æ³•
    """
    __abstract__ = True
    
    # ä¸»é”®
    id = db.Column(db.String(36), primary_key=True)
    
    # æ—¶é—´æˆ³
    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    def to_dict(self) -> dict:
        """
        è½¬æ¢ä¸ºå­—å…¸
        
        Returns:
            dict: æ¨¡å‹æ•°æ®å­—å…¸
        """
        return {
            column.name: getattr(self, column.name)
            for column in self.__table__.columns
        }
    
    def save(self):
        """ä¿å­˜åˆ°æ•°æ®åº“"""
        db.session.add(self)
        db.session.commit()
    
    def delete(self):
        """ä»æ•°æ®åº“åˆ é™¤"""
        db.session.delete(self)
        db.session.commit()
```

#### 2.2 ç”¨æˆ·è´¦æˆ·æ¨¡å‹

**`api/models/account.py`**
```python
"""
ç”¨æˆ·è´¦æˆ·æ•°æ®æ¨¡å‹
"""
import uuid
from extensions.ext_database import db
from models.base import BaseModel
from werkzeug.security import generate_password_hash, check_password_hash

class Account(BaseModel):
    """
    ç”¨æˆ·è´¦æˆ·è¡¨
    å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œè®¤è¯æ•°æ®
    """
    __tablename__ = "accounts"
    
    # ç”¨æˆ·ä¿¡æ¯
    email = db.Column(db.String(255), nullable=False, unique=True, index=True)
    name = db.Column(db.String(255), nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    
    # è´¦æˆ·çŠ¶æ€
    status = db.Column(db.String(20), nullable=False, default="active")  # active, banned, deleted
    
    # è§’è‰²å’Œæƒé™
    role = db.Column(db.String(20), nullable=False, default="user")  # admin, user
    
    # ä¸ªäººèµ„æ–™
    avatar = db.Column(db.String(255))
    timezone = db.Column(db.String(50), default="UTC")
    language = db.Column(db.String(10), default="zh-Hans")
    
    def __init__(self, email: str, name: str, password: str):
        """
        åˆå§‹åŒ–è´¦æˆ·
        
        Args:
            email: é‚®ç®±åœ°å€
            name: ç”¨æˆ·å
            password: æ˜æ–‡å¯†ç 
        """
        self.id = str(uuid.uuid4())
        self.email = email
        self.name = name
        self.set_password(password)
    
    def set_password(self, password: str):
        """
        è®¾ç½®å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
        
        Args:
            password: æ˜æ–‡å¯†ç 
        """
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password: str) -> bool:
        """
        éªŒè¯å¯†ç 
        
        Args:
            password: å¾…éªŒè¯çš„æ˜æ–‡å¯†ç 
            
        Returns:
            bool: å¯†ç æ˜¯å¦æ­£ç¡®
        """
        return check_password_hash(self.password_hash, password)
    
    def __repr__(self):
        return f"<Account {self.email}>"
```

#### 2.3 åº”ç”¨æ¨¡å‹

**`api/models/app.py`**
```python
"""
åº”ç”¨æ•°æ®æ¨¡å‹
"""
import uuid
from extensions.ext_database import db
from models.base import BaseModel

class App(BaseModel):
    """
    åº”ç”¨è¡¨
    å­˜å‚¨ç”¨æˆ·åˆ›å»ºçš„ AI åº”ç”¨
    """
    __tablename__ = "apps"
    
    # åŸºæœ¬ä¿¡æ¯
    name = db.Column(db.String(255), nullable=False)
    description = db.Column(db.Text)
    icon = db.Column(db.String(255))
    icon_background = db.Column(db.String(7))  # é¢œè‰²ä»£ç 
    
    # åº”ç”¨ç±»å‹
    mode = db.Column(db.String(20), nullable=False)  # chat, completion, agent, workflow
    
    # æ‰€å±å…³ç³»
    account_id = db.Column(db.String(36), db.ForeignKey("accounts.id"), nullable=False, index=True)
    
    # çŠ¶æ€
    status = db.Column(db.String(20), nullable=False, default="draft")  # draft, published, archived
    
    # é…ç½®ï¼ˆå­˜å‚¨ JSONï¼‰
    model_config = db.Column(db.JSON)
    
    # å…³ç³»
    account = db.relationship("Account", backref=db.backref("apps", lazy="dynamic"))
    
    def __init__(self, name: str, mode: str, account_id: str):
        """
        åˆå§‹åŒ–åº”ç”¨
        
        Args:
            name: åº”ç”¨åç§°
            mode: åº”ç”¨ç±»å‹
            account_id: æ‰€å±è´¦æˆ· ID
        """
        self.id = str(uuid.uuid4())
        self.name = name
        self.mode = mode
        self.account_id = account_id
    
    def __repr__(self):
        return f"<App {self.name}>"
```

#### 2.4 å·¥ä½œæµæ¨¡å‹

**`api/models/workflow.py`**
```python
"""
å·¥ä½œæµæ•°æ®æ¨¡å‹
"""
import uuid
from extensions.ext_database import db
from models.base import BaseModel

class Workflow(BaseModel):
    """
    å·¥ä½œæµè¡¨
    å­˜å‚¨å·¥ä½œæµå®šä¹‰
    """
    __tablename__ = "workflows"
    
    # åŸºæœ¬ä¿¡æ¯
    app_id = db.Column(db.String(36), db.ForeignKey("apps.id"), nullable=False, index=True)
    version = db.Column(db.String(20), nullable=False)
    
    # å·¥ä½œæµå®šä¹‰ï¼ˆå­˜å‚¨ JSONï¼‰
    graph = db.Column(db.JSON, nullable=False)  # èŠ‚ç‚¹å’Œè¾¹çš„å®šä¹‰
    features = db.Column(db.JSON)  # åŠŸèƒ½é…ç½®
    
    # çŠ¶æ€
    status = db.Column(db.String(20), nullable=False, default="draft")  # draft, published
    
    # å…³ç³»
    app = db.relationship("App", backref=db.backref("workflows", lazy="dynamic"))
    
    def __init__(self, app_id: str, version: str = "1.0"):
        """
        åˆå§‹åŒ–å·¥ä½œæµ
        
        Args:
            app_id: æ‰€å±åº”ç”¨ ID
            version: ç‰ˆæœ¬å·
        """
        self.id = str(uuid.uuid4())
        self.app_id = app_id
        self.version = version
        self.graph = {"nodes": [], "edges": []}
    
    def __repr__(self):
        return f"<Workflow {self.id} v{self.version}>"
```

#### 2.5 æ•°æ®é›†æ¨¡å‹

**`api/models/dataset.py`**
```python
"""
æ•°æ®é›†ï¼ˆçŸ¥è¯†åº“ï¼‰æ•°æ®æ¨¡å‹
"""
import uuid
from extensions.ext_database import db
from models.base import BaseModel

class Dataset(BaseModel):
    """
    æ•°æ®é›†è¡¨
    å­˜å‚¨çŸ¥è¯†åº“ä¿¡æ¯
    """
    __tablename__ = "datasets"
    
    # åŸºæœ¬ä¿¡æ¯
    name = db.Column(db.String(255), nullable=False)
    description = db.Column(db.Text)
    
    # æ‰€å±å…³ç³»
    account_id = db.Column(db.String(36), db.ForeignKey("accounts.id"), nullable=False, index=True)
    
    # é…ç½®
    indexing_technique = db.Column(db.String(20), nullable=False, default="high_quality")  # economy, high_quality
    
    # ç»Ÿè®¡ä¿¡æ¯
    doc_count = db.Column(db.Integer, default=0)
    
    # å…³ç³»
    account = db.relationship("Account", backref=db.backref("datasets", lazy="dynamic"))
    
    def __init__(self, name: str, account_id: str):
        """
        åˆå§‹åŒ–æ•°æ®é›†
        
        Args:
            name: æ•°æ®é›†åç§°
            account_id: æ‰€å±è´¦æˆ· ID
        """
        self.id = str(uuid.uuid4())
        self.name = name
        self.account_id = account_id
    
    def __repr__(self):
        return f"<Dataset {self.name}>"


class Document(BaseModel):
    """
    æ–‡æ¡£è¡¨
    å­˜å‚¨ä¸Šä¼ åˆ°çŸ¥è¯†åº“çš„æ–‡æ¡£
    """
    __tablename__ = "documents"
    
    # åŸºæœ¬ä¿¡æ¯
    dataset_id = db.Column(db.String(36), db.ForeignKey("datasets.id"), nullable=False, index=True)
    name = db.Column(db.String(255), nullable=False)
    
    # æ–‡ä»¶ä¿¡æ¯
    file_id = db.Column(db.String(255))
    file_type = db.Column(db.String(50))
    file_size = db.Column(db.Integer)
    
    # å¤„ç†çŠ¶æ€
    indexing_status = db.Column(db.String(20), default="pending")  # pending, processing, completed, error
    
    # åˆ†æ®µç»Ÿè®¡
    segment_count = db.Column(db.Integer, default=0)
    
    # å…³ç³»
    dataset = db.relationship("Dataset", backref=db.backref("documents", lazy="dynamic"))
    
    def __init__(self, dataset_id: str, name: str):
        """
        åˆå§‹åŒ–æ–‡æ¡£
        
        Args:
            dataset_id: æ‰€å±æ•°æ®é›† ID
            name: æ–‡æ¡£åç§°
        """
        self.id = str(uuid.uuid4())
        self.dataset_id = dataset_id
        self.name = name
    
    def __repr__(self):
        return f"<Document {self.name}>"
```

---

### æ­¥éª¤ 3ï¼šå®ç°æœåŠ¡å±‚

#### 3.1 è®¤è¯æœåŠ¡

**`api/services/auth_service.py`**
```python
"""
è®¤è¯æœåŠ¡
å¤„ç†ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€Token ç®¡ç†ç­‰
"""
import jwt
from datetime import datetime, timedelta
from typing import Optional, Tuple
from flask import current_app
from models.account import Account
from extensions.ext_database import db

class AuthService:
    """è®¤è¯æœåŠ¡ç±»"""
    
    @staticmethod
    def register(email: str, name: str, password: str) -> Tuple[bool, str, Optional[Account]]:
        """
        ç”¨æˆ·æ³¨å†Œ
        
        Args:
            email: é‚®ç®±åœ°å€
            name: ç”¨æˆ·å
            password: å¯†ç 
            
        Returns:
            Tuple[bool, str, Optional[Account]]: (æˆåŠŸæ ‡è¯†, æ¶ˆæ¯, ç”¨æˆ·å¯¹è±¡)
        """
        # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
        existing_user = Account.query.filter_by(email=email).first()
        if existing_user:
            return False, "é‚®ç®±å·²è¢«æ³¨å†Œ", None
        
        # åˆ›å»ºæ–°ç”¨æˆ·
        try:
            account = Account(email=email, name=name, password=password)
            account.save()
            return True, "æ³¨å†ŒæˆåŠŸ", account
        except Exception as e:
            db.session.rollback()
            return False, f"æ³¨å†Œå¤±è´¥: {str(e)}", None
    
    @staticmethod
    def login(email: str, password: str) -> Tuple[bool, str, Optional[dict]]:
        """
        ç”¨æˆ·ç™»å½•
        
        Args:
            email: é‚®ç®±åœ°å€
            password: å¯†ç 
            
        Returns:
            Tuple[bool, str, Optional[dict]]: (æˆåŠŸæ ‡è¯†, æ¶ˆæ¯, Tokenæ•°æ®)
        """
        # æŸ¥æ‰¾ç”¨æˆ·
        account = Account.query.filter_by(email=email).first()
        if not account:
            return False, "ç”¨æˆ·ä¸å­˜åœ¨", None
        
        # éªŒè¯å¯†ç 
        if not account.check_password(password):
            return False, "å¯†ç é”™è¯¯", None
        
        # æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        if account.status != "active":
            return False, "è´¦æˆ·å·²è¢«ç¦ç”¨", None
        
        # ç”Ÿæˆ Token
        tokens = AuthService.generate_tokens(account.id)
        return True, "ç™»å½•æˆåŠŸ", tokens
    
    @staticmethod
    def generate_tokens(account_id: str) -> dict:
        """
        ç”Ÿæˆè®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œ
        
        Args:
            account_id: è´¦æˆ· ID
            
        Returns:
            dict: åŒ…å« access_token å’Œ refresh_token çš„å­—å…¸
        """
        secret_key = current_app.config["JWT_SECRET_KEY"]
        
        # ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸï¼‰
        access_payload = {
            "account_id": account_id,
            "type": "access",
            "exp": datetime.utcnow() + timedelta(seconds=current_app.config["JWT_ACCESS_TOKEN_EXPIRES"])
        }
        access_token = jwt.encode(access_payload, secret_key, algorithm="HS256")
        
        # ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰
        refresh_payload = {
            "account_id": account_id,
            "type": "refresh",
            "exp": datetime.utcnow() + timedelta(seconds=current_app.config["JWT_REFRESH_TOKEN_EXPIRES"])
        }
        refresh_token = jwt.encode(refresh_payload, secret_key, algorithm="HS256")
        
        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "expires_in": current_app.config["JWT_ACCESS_TOKEN_EXPIRES"]
        }
    
    @staticmethod
    def verify_token(token: str) -> Tuple[bool, Optional[str]]:
        """
        éªŒè¯ Token
        
        Args:
            token: JWT Token
            
        Returns:
            Tuple[bool, Optional[str]]: (æ˜¯å¦æœ‰æ•ˆ, è´¦æˆ·ID)
        """
        try:
            secret_key = current_app.config["JWT_SECRET_KEY"]
            payload = jwt.decode(token, secret_key, algorithms=["HS256"])
            return True, payload.get("account_id")
        except jwt.ExpiredSignatureError:
            return False, None
        except jwt.InvalidTokenError:
            return False, None
```

#### 3.2 åº”ç”¨æœåŠ¡

**`api/services/app_service.py`**
```python
"""
åº”ç”¨æœåŠ¡
å¤„ç†åº”ç”¨çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œ
"""
from typing import Optional, List, Tuple
from models.app import App
from extensions.ext_database import db

class AppService:
    """åº”ç”¨æœåŠ¡ç±»"""
    
    @staticmethod
    def create_app(
        name: str,
        mode: str,
        account_id: str,
        description: Optional[str] = None,
        icon: Optional[str] = None
    ) -> Tuple[bool, str, Optional[App]]:
        """
        åˆ›å»ºåº”ç”¨
        
        Args:
            name: åº”ç”¨åç§°
            mode: åº”ç”¨ç±»å‹
            account_id: æ‰€å±è´¦æˆ· ID
            description: åº”ç”¨æè¿°
            icon: åº”ç”¨å›¾æ ‡
            
        Returns:
            Tuple[bool, str, Optional[App]]: (æˆåŠŸæ ‡è¯†, æ¶ˆæ¯, åº”ç”¨å¯¹è±¡)
        """
        # éªŒè¯åº”ç”¨ç±»å‹
        valid_modes = ["chat", "completion", "agent", "workflow"]
        if mode not in valid_modes:
            return False, f"æ— æ•ˆçš„åº”ç”¨ç±»å‹ï¼Œå¿…é¡»æ˜¯: {', '.join(valid_modes)}", None
        
        try:
            # åˆ›å»ºåº”ç”¨
            app = App(name=name, mode=mode, account_id=account_id)
            if description:
                app.description = description
            if icon:
                app.icon = icon
            
            app.save()
            return True, "åº”ç”¨åˆ›å»ºæˆåŠŸ", app
        except Exception as e:
            db.session.rollback()
            return False, f"åº”ç”¨åˆ›å»ºå¤±è´¥: {str(e)}", None
    
    @staticmethod
    def get_app(app_id: str) -> Optional[App]:
        """
        è·å–åº”ç”¨
        
        Args:
            app_id: åº”ç”¨ ID
            
        Returns:
            Optional[App]: åº”ç”¨å¯¹è±¡ï¼Œä¸å­˜åœ¨åˆ™è¿”å› None
        """
        return App.query.filter_by(id=app_id).first()
    
    @staticmethod
    def list_apps(account_id: str, status: Optional[str] = None) -> List[App]:
        """
        åˆ—å‡ºç”¨æˆ·çš„åº”ç”¨
        
        Args:
            account_id: è´¦æˆ· ID
            status: åº”ç”¨çŠ¶æ€è¿‡æ»¤
            
        Returns:
            List[App]: åº”ç”¨åˆ—è¡¨
        """
        query = App.query.filter_by(account_id=account_id)
        
        if status:
            query = query.filter_by(status=status)
        
        return query.order_by(App.created_at.desc()).all()
    
    @staticmethod
    def update_app(
        app_id: str,
        **kwargs
    ) -> Tuple[bool, str, Optional[App]]:
        """
        æ›´æ–°åº”ç”¨
        
        Args:
            app_id: åº”ç”¨ ID
            **kwargs: è¦æ›´æ–°çš„å­—æ®µ
            
        Returns:
            Tuple[bool, str, Optional[App]]: (æˆåŠŸæ ‡è¯†, æ¶ˆæ¯, åº”ç”¨å¯¹è±¡)
        """
        app = App.query.filter_by(id=app_id).first()
        if not app:
            return False, "åº”ç”¨ä¸å­˜åœ¨", None
        
        try:
            # æ›´æ–°å…è®¸çš„å­—æ®µ
            allowed_fields = ["name", "description", "icon", "icon_background", "status", "model_config"]
            for key, value in kwargs.items():
                if key in allowed_fields:
                    setattr(app, key, value)
            
            app.save()
            return True, "åº”ç”¨æ›´æ–°æˆåŠŸ", app
        except Exception as e:
            db.session.rollback()
            return False, f"åº”ç”¨æ›´æ–°å¤±è´¥: {str(e)}", None
    
    @staticmethod
    def delete_app(app_id: str) -> Tuple[bool, str]:
        """
        åˆ é™¤åº”ç”¨
        
        Args:
            app_id: åº”ç”¨ ID
            
        Returns:
            Tuple[bool, str]: (æˆåŠŸæ ‡è¯†, æ¶ˆæ¯)
        """
        app = App.query.filter_by(id=app_id).first()
        if not app:
            return False, "åº”ç”¨ä¸å­˜åœ¨"
        
        try:
            app.delete()
            return True, "åº”ç”¨åˆ é™¤æˆåŠŸ"
        except Exception as e:
            db.session.rollback()
            return False, f"åº”ç”¨åˆ é™¤å¤±è´¥: {str(e)}"
```

---

### æ­¥éª¤ 4ï¼šå®ç°æ§åˆ¶å™¨å±‚

#### 4.1 è®¤è¯æ§åˆ¶å™¨

**`api/controllers/console/auth/login.py`**
```python
"""
ç™»å½•æ§åˆ¶å™¨
å¤„ç†ç”¨æˆ·ç™»å½•ç›¸å…³çš„ HTTP è¯·æ±‚
"""
from flask import Blueprint, request, jsonify
from services.auth_service import AuthService

# åˆ›å»ºè“å›¾
bp = Blueprint("auth_login", __name__, url_prefix="/api/console/auth")

@bp.route("/login", methods=["POST"])
def login():
    """
    ç”¨æˆ·ç™»å½•æ¥å£
    
    è¯·æ±‚ä½“:
        {
            "email": "user@example.com",
            "password": "password123"
        }
    
    è¿”å›:
        {
            "success": true,
            "message": "ç™»å½•æˆåŠŸ",
            "data": {
                "access_token": "xxx",
                "refresh_token": "xxx",
                "expires_in": 3600
            }
        }
    """
    # è·å–è¯·æ±‚æ•°æ®
    data = request.get_json()
    email = data.get("email")
    password = data.get("password")
    
    # éªŒè¯å¿…å¡«å­—æ®µ
    if not email or not password:
        return jsonify({
            "success": False,
            "message": "é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©º"
        }), 400
    
    # è°ƒç”¨æœåŠ¡å±‚å¤„ç†ç™»å½•
    success, message, tokens = AuthService.login(email, password)
    
    if success:
        return jsonify({
            "success": True,
            "message": message,
            "data": tokens
        }), 200
    else:
        return jsonify({
            "success": False,
            "message": message
        }), 401


@bp.route("/register", methods=["POST"])
def register():
    """
    ç”¨æˆ·æ³¨å†Œæ¥å£
    
    è¯·æ±‚ä½“:
        {
            "email": "user@example.com",
            "name": "ç”¨æˆ·å",
            "password": "password123"
        }
    
    è¿”å›:
        {
            "success": true,
            "message": "æ³¨å†ŒæˆåŠŸ",
            "data": {
                "id": "xxx",
                "email": "user@example.com",
                "name": "ç”¨æˆ·å"
            }
        }
    """
    # è·å–è¯·æ±‚æ•°æ®
    data = request.get_json()
    email = data.get("email")
    name = data.get("name")
    password = data.get("password")
    
    # éªŒè¯å¿…å¡«å­—æ®µ
    if not email or not name or not password:
        return jsonify({
            "success": False,
            "message": "é‚®ç®±ã€ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º"
        }), 400
    
    # è°ƒç”¨æœåŠ¡å±‚å¤„ç†æ³¨å†Œ
    success, message, account = AuthService.register(email, name, password)
    
    if success:
        return jsonify({
            "success": True,
            "message": message,
            "data": {
                "id": account.id,
                "email": account.email,
                "name": account.name
            }
        }), 201
    else:
        return jsonify({
            "success": False,
            "message": message
        }), 400
```

#### 4.2 åº”ç”¨æ§åˆ¶å™¨

**`api/controllers/console/app/apps.py`**
```python
"""
åº”ç”¨ç®¡ç†æ§åˆ¶å™¨
å¤„ç†åº”ç”¨çš„ CRUD æ“ä½œ
"""
from flask import Blueprint, request, jsonify, g
from services.app_service import AppService
from libs.decorators import require_auth

# åˆ›å»ºè“å›¾
bp = Blueprint("console_apps", __name__, url_prefix="/api/console/apps")

@bp.route("", methods=["GET"])
@require_auth
def list_apps():
    """
    è·å–åº”ç”¨åˆ—è¡¨
    
    æŸ¥è¯¢å‚æ•°:
        status: åº”ç”¨çŠ¶æ€è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    
    è¿”å›:
        {
            "success": true,
            "data": [
                {
                    "id": "xxx",
                    "name": "åº”ç”¨åç§°",
                    "mode": "chat",
                    ...
                }
            ]
        }
    """
    # è·å–å½“å‰ç”¨æˆ· IDï¼ˆç”±è®¤è¯è£…é¥°å™¨æ³¨å…¥ï¼‰
    account_id = g.account_id
    
    # è·å–æŸ¥è¯¢å‚æ•°
    status = request.args.get("status")
    
    # è°ƒç”¨æœåŠ¡å±‚è·å–åº”ç”¨åˆ—è¡¨
    apps = AppService.list_apps(account_id, status)
    
    return jsonify({
        "success": True,
        "data": [app.to_dict() for app in apps]
    }), 200


@bp.route("", methods=["POST"])
@require_auth
def create_app():
    """
    åˆ›å»ºåº”ç”¨
    
    è¯·æ±‚ä½“:
        {
            "name": "åº”ç”¨åç§°",
            "mode": "chat",
            "description": "åº”ç”¨æè¿°"
        }
    
    è¿”å›:
        {
            "success": true,
            "message": "åº”ç”¨åˆ›å»ºæˆåŠŸ",
            "data": {
                "id": "xxx",
                "name": "åº”ç”¨åç§°",
                ...
            }
        }
    """
    # è·å–å½“å‰ç”¨æˆ· ID
    account_id = g.account_id
    
    # è·å–è¯·æ±‚æ•°æ®
    data = request.get_json()
    name = data.get("name")
    mode = data.get("mode")
    description = data.get("description")
    icon = data.get("icon")
    
    # éªŒè¯å¿…å¡«å­—æ®µ
    if not name or not mode:
        return jsonify({
            "success": False,
            "message": "åº”ç”¨åç§°å’Œç±»å‹ä¸èƒ½ä¸ºç©º"
        }), 400
    
    # è°ƒç”¨æœåŠ¡å±‚åˆ›å»ºåº”ç”¨
    success, message, app = AppService.create_app(
        name=name,
        mode=mode,
        account_id=account_id,
        description=description,
        icon=icon
    )
    
    if success:
        return jsonify({
            "success": True,
            "message": message,
            "data": app.to_dict()
        }), 201
    else:
        return jsonify({
            "success": False,
            "message": message
        }), 400


@bp.route("/<app_id>", methods=["GET"])
@require_auth
def get_app(app_id: str):
    """
    è·å–å•ä¸ªåº”ç”¨è¯¦æƒ…
    
    è¿”å›:
        {
            "success": true,
            "data": {
                "id": "xxx",
                "name": "åº”ç”¨åç§°",
                ...
            }
        }
    """
    # è·å–åº”ç”¨
    app = AppService.get_app(app_id)
    
    if not app:
        return jsonify({
            "success": False,
            "message": "åº”ç”¨ä¸å­˜åœ¨"
        }), 404
    
    # éªŒè¯æƒé™ï¼ˆç¡®ä¿æ˜¯ç”¨æˆ·è‡ªå·±çš„åº”ç”¨ï¼‰
    if app.account_id != g.account_id:
        return jsonify({
            "success": False,
            "message": "æ— æƒè®¿é—®æ­¤åº”ç”¨"
        }), 403
    
    return jsonify({
        "success": True,
        "data": app.to_dict()
    }), 200


@bp.route("/<app_id>", methods=["PUT"])
@require_auth
def update_app(app_id: str):
    """
    æ›´æ–°åº”ç”¨
    
    è¯·æ±‚ä½“:
        {
            "name": "æ–°åç§°",
            "description": "æ–°æè¿°"
        }
    
    è¿”å›:
        {
            "success": true,
            "message": "åº”ç”¨æ›´æ–°æˆåŠŸ",
            "data": {...}
        }
    """
    # è·å–åº”ç”¨å¹¶éªŒè¯æƒé™
    app = AppService.get_app(app_id)
    if not app or app.account_id != g.account_id:
        return jsonify({
            "success": False,
            "message": "åº”ç”¨ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
        }), 404
    
    # è·å–æ›´æ–°æ•°æ®
    data = request.get_json()
    
    # è°ƒç”¨æœåŠ¡å±‚æ›´æ–°
    success, message, updated_app = AppService.update_app(app_id, **data)
    
    if success:
        return jsonify({
            "success": True,
            "message": message,
            "data": updated_app.to_dict()
        }), 200
    else:
        return jsonify({
            "success": False,
            "message": message
        }), 400


@bp.route("/<app_id>", methods=["DELETE"])
@require_auth
def delete_app(app_id: str):
    """
    åˆ é™¤åº”ç”¨
    
    è¿”å›:
        {
            "success": true,
            "message": "åº”ç”¨åˆ é™¤æˆåŠŸ"
        }
    """
    # è·å–åº”ç”¨å¹¶éªŒè¯æƒé™
    app = AppService.get_app(app_id)
    if not app or app.account_id != g.account_id:
        return jsonify({
            "success": False,
            "message": "åº”ç”¨ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
        }), 404
    
    # è°ƒç”¨æœåŠ¡å±‚åˆ é™¤
    success, message = AppService.delete_app(app_id)
    
    if success:
        return jsonify({
            "success": True,
            "message": message
        }), 200
    else:
        return jsonify({
            "success": False,
            "message": message
        }), 400
```

---

### æ­¥éª¤ 5ï¼šå®ç°å·¥å…·åº“å’Œä¸­é—´ä»¶

#### 5.1 è®¤è¯è£…é¥°å™¨

**`api/libs/decorators.py`**
```python
"""
è£…é¥°å™¨å·¥å…·
æä¾›é€šç”¨çš„è£…é¥°å™¨å‡½æ•°
"""
from functools import wraps
from flask import request, jsonify, g
from services.auth_service import AuthService

def require_auth(f):
    """
    è®¤è¯è£…é¥°å™¨
    éªŒè¯è¯·æ±‚ä¸­çš„ JWT Tokenï¼Œå¹¶å°†è´¦æˆ· ID æ³¨å…¥åˆ° g å¯¹è±¡
    
    ç”¨æ³•:
        @bp.route("/protected")
        @require_auth
        def protected_route():
            account_id = g.account_id
            ...
    """
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # ä»è¯·æ±‚å¤´è·å– Token
        auth_header = request.headers.get("Authorization")
        if not auth_header:
            return jsonify({
                "success": False,
                "message": "ç¼ºå°‘è®¤è¯ä»¤ç‰Œ"
            }), 401
        
        # è§£æ Tokenï¼ˆæ ¼å¼ï¼šBearer <token>ï¼‰
        try:
            token = auth_header.split(" ")[1]
        except IndexError:
            return jsonify({
                "success": False,
                "message": "è®¤è¯ä»¤ç‰Œæ ¼å¼é”™è¯¯"
            }), 401
        
        # éªŒè¯ Token
        valid, account_id = AuthService.verify_token(token)
        if not valid:
            return jsonify({
                "success": False,
                "message": "è®¤è¯ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"
            }), 401
        
        # å°†è´¦æˆ· ID æ³¨å…¥åˆ° g å¯¹è±¡
        g.account_id = account_id
        
        return f(*args, **kwargs)
    
    return decorated_function
```

#### 5.2 é”™è¯¯å¤„ç†

**`api/libs/errors.py`**
```python
"""
é”™è¯¯å¤„ç†æ¨¡å—
å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸ç±»å’Œé”™è¯¯å¤„ç†å™¨
"""

class BaseError(Exception):
    """åŸºç¡€é”™è¯¯ç±»"""
    code = "UNKNOWN_ERROR"
    status_code = 500
    message = "æœªçŸ¥é”™è¯¯"
    
    def __init__(self, message: str = None):
        if message:
            self.message = message
        super().__init__(self.message)


class ValidationError(BaseError):
    """éªŒè¯é”™è¯¯"""
    code = "VALIDATION_ERROR"
    status_code = 400
    message = "æ•°æ®éªŒè¯å¤±è´¥"


class AuthenticationError(BaseError):
    """è®¤è¯é”™è¯¯"""
    code = "AUTHENTICATION_ERROR"
    status_code = 401
    message = "è®¤è¯å¤±è´¥"


class PermissionError(BaseError):
    """æƒé™é”™è¯¯"""
    code = "PERMISSION_ERROR"
    status_code = 403
    message = "æƒé™ä¸è¶³"


class NotFoundError(BaseError):
    """èµ„æºæœªæ‰¾åˆ°é”™è¯¯"""
    code = "NOT_FOUND_ERROR"
    status_code = 404
    message = "èµ„æºä¸å­˜åœ¨"


def register_error_handlers(app):
    """
    æ³¨å†Œå…¨å±€é”™è¯¯å¤„ç†å™¨
    
    Args:
        app: Flask åº”ç”¨å®ä¾‹
    """
    @app.errorhandler(BaseError)
    def handle_base_error(error):
        """å¤„ç†è‡ªå®šä¹‰é”™è¯¯"""
        return {
            "success": False,
            "code": error.code,
            "message": error.message
        }, error.status_code
    
    @app.errorhandler(404)
    def handle_not_found(error):
        """å¤„ç† 404 é”™è¯¯"""
        return {
            "success": False,
            "code": "NOT_FOUND",
            "message": "è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨"
        }, 404
    
    @app.errorhandler(500)
    def handle_internal_error(error):
        """å¤„ç† 500 é”™è¯¯"""
        app.logger.error(f"Internal error: {str(error)}")
        return {
            "success": False,
            "code": "INTERNAL_ERROR",
            "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯"
        }, 500
```

---

### æ­¥éª¤ 6ï¼šæ›´æ–°åº”ç”¨å·¥å‚

æ›´æ–° `app_factory.py` ä»¥æ³¨å†Œæ‰€æœ‰ç»„ä»¶ï¼š

**`api/app_factory.py`**
```python
"""
Flask åº”ç”¨å·¥å‚ï¼ˆå®Œæ•´ç‰ˆï¼‰
"""
from flask import Flask
from flask_cors import CORS
from configs.app_config import get_config
from extensions.ext_database import db, init_app as init_db
from extensions.ext_redis import init_app as init_redis
from libs.errors import register_error_handlers

def create_app() -> Flask:
    """åˆ›å»º Flask åº”ç”¨å®ä¾‹"""
    app = Flask(__name__)
    
    # åŠ è½½é…ç½®
    config = get_config()
    app.config.from_object(config)
    
    # åˆå§‹åŒ–æ‰©å±•
    initialize_extensions(app)
    
    # æ³¨å†Œè“å›¾
    register_blueprints(app)
    
    # æ³¨å†Œé”™è¯¯å¤„ç†
    register_error_handlers(app)
    
    return app

def initialize_extensions(app: Flask) -> None:
    """åˆå§‹åŒ– Flask æ‰©å±•"""
    # CORS
    CORS(app, origins=app.config["CORS_ALLOW_ORIGINS"])
    
    # æ•°æ®åº“
    init_db(app)
    
    # Redis
    init_redis(app)
    
    app.logger.info("æ‰€æœ‰æ‰©å±•åˆå§‹åŒ–å®Œæˆ")

def register_blueprints(app: Flask) -> None:
    """æ³¨å†Œè“å›¾ï¼ˆè·¯ç”±ï¼‰"""
    # è®¤è¯ç›¸å…³
    from controllers.console.auth.login import bp as auth_bp
    app.register_blueprint(auth_bp)
    
    # åº”ç”¨ç®¡ç†
    from controllers.console.app.apps import bp as apps_bp
    app.register_blueprint(apps_bp)
    
    app.logger.info("æ‰€æœ‰è“å›¾æ³¨å†Œå®Œæˆ")
```

---

## å¼€å‘æ£€æŸ¥æ¸…å•

æ¯å®Œæˆä¸€ä¸ªæ¨¡å—ï¼Œéœ€è¦éªŒè¯ï¼š

- [ ] ä»£ç ç¬¦åˆ PEP 8 è§„èŒƒ
- [ ] æ‰€æœ‰æ³¨é‡Šä½¿ç”¨ä¸­æ–‡
- [ ] ç§»é™¤äº†ä½œè€…ä¿¡æ¯
- [ ] å‡½æ•°æœ‰æ¸…æ™°çš„æ–‡æ¡£å­—ç¬¦ä¸²
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æ•°æ®éªŒè¯å……åˆ†
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™ï¼ˆå¯é€‰ï¼‰

## ä¸‹ä¸€æ­¥

å®Œæˆåç«¯æ ¸å¿ƒåŠŸèƒ½åï¼Œè¿›å…¥ï¼š
ğŸ‘‰ **é˜¶æ®µå››ï¼šå¤åˆ» Web å‰ç«¯åº”ç”¨**
