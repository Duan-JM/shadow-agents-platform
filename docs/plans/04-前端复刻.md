# 阶段四：复刻 Web 前端应用

## 目标
重写前端 Web 应用，实现用户界面和交互功能。移除所有 Dify 品牌元素，使用中文注释，提供可自定义的界面。

---

## 总体思路

### 技术选型
- **框架**: Next.js 14+ (App Router)
- **UI 库**: React 18+
- **样式**: Tailwind CSS
- **状态管理**: React Context + Hooks
- **类型检查**: TypeScript
- **HTTP 客户端**: Axios/Fetch API

### 设计原则
1. **组件化**：可复用的组件设计
2. **响应式**：适配各种屏幕尺寸
3. **可定制**：支持主题和品牌自定义
4. **性能优化**：代码分割、懒加载
5. **用户体验**：流畅的交互和反馈

---

## 详细执行步骤

### 步骤 1：初始化项目和基础配置

#### 1.1 安装依赖

**`web/package.json`**
```json
{
  "name": "shadow-agents-web",
  "version": "0.1.0",
  "description": "Shadow Agents Platform Web Application",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "next": "^14.0.0",
    "typescript": "^5.3.0",
    "tailwindcss": "^3.4.0",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "@headlessui/react": "^1.7.17",
    "@heroicons/react": "^2.1.1",
    "axios": "^1.6.2",
    "classnames": "^2.3.2",
    "react-hook-form": "^7.49.2",
    "react-hot-toast": "^2.4.1",
    "swr": "^2.2.4"
  },
  "devDependencies": {
    "@types/node": "^20.10.5",
    "@types/react": "^18.2.45",
    "@types/react-dom": "^18.2.18",
    "eslint": "^8.56.0",
    "eslint-config-next": "^14.0.4"
  }
}
```

#### 1.2 Tailwind CSS 配置

**`web/tailwind.config.js`**
```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      colors: {
        // 自定义主题色（可轻松替换）
        primary: {
          50: '#f0f9ff',
          100: '#e0f2fe',
          200: '#bae6fd',
          300: '#7dd3fc',
          400: '#38bdf8',
          500: '#0ea5e9',
          600: '#0284c7',
          700: '#0369a1',
          800: '#075985',
          900: '#0c4a6e',
        },
      },
      fontFamily: {
        sans: ['Inter', 'sans-serif'],
      },
    },
  },
  plugins: [
    require('@tailwindcss/forms'),
    require('@tailwindcss/typography'),
  ],
}
```

#### 1.3 TypeScript 配置已在步骤2完成

#### 1.4 环境变量配置

**`web/.env.example`**
```env
# API 地址
NEXT_PUBLIC_API_URL=http://localhost:5001

# 应用名称（可自定义）
NEXT_PUBLIC_APP_NAME=Shadow Agents Platform

# 应用描述
NEXT_PUBLIC_APP_DESCRIPTION=AI应用开发平台
```

---

### 步骤 2：创建基础组件库

#### 2.1 按钮组件

**`web/components/base/Button.tsx`**
```typescript
/**
 * 按钮组件
 * 提供统一的按钮样式和交互
 */
import React from 'react'
import classNames from 'classnames'

interface ButtonProps {
  /** 按钮文本 */
  children: React.ReactNode
  /** 按钮类型 */
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost' | 'danger'
  /** 按钮大小 */
  size?: 'sm' | 'md' | 'lg'
  /** 是否禁用 */
  disabled?: boolean
  /** 是否加载中 */
  loading?: boolean
  /** 点击事件 */
  onClick?: () => void
  /** 按钮类型（HTML） */
  type?: 'button' | 'submit' | 'reset'
  /** 自定义类名 */
  className?: string
}

export const Button: React.FC<ButtonProps> = ({
  children,
  variant = 'primary',
  size = 'md',
  disabled = false,
  loading = false,
  onClick,
  type = 'button',
  className,
}) => {
  const baseStyles = 'inline-flex items-center justify-center font-medium rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2'
  
  const variantStyles = {
    primary: 'bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500',
    secondary: 'bg-gray-200 text-gray-900 hover:bg-gray-300 focus:ring-gray-500',
    outline: 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-primary-500',
    ghost: 'text-gray-700 hover:bg-gray-100 focus:ring-gray-500',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
  }
  
  const sizeStyles = {
    sm: 'px-3 py-1.5 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg',
  }
  
  const disabledStyles = 'opacity-50 cursor-not-allowed'
  
  return (
    <button
      type={type}
      onClick={onClick}
      disabled={disabled || loading}
      className={classNames(
        baseStyles,
        variantStyles[variant],
        sizeStyles[size],
        (disabled || loading) && disabledStyles,
        className
      )}
    >
      {loading && (
        <svg className="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
      )}
      {children}
    </button>
  )
}
```

#### 2.2 输入框组件

**`web/components/base/Input.tsx`**
```typescript
/**
 * 输入框组件
 * 提供统一的输入框样式
 */
import React from 'react'
import classNames from 'classnames'

interface InputProps {
  /** 标签文本 */
  label?: string
  /** 输入框类型 */
  type?: 'text' | 'email' | 'password' | 'number'
  /** 占位符 */
  placeholder?: string
  /** 输入值 */
  value: string
  /** 值变化回调 */
  onChange: (value: string) => void
  /** 是否必填 */
  required?: boolean
  /** 是否禁用 */
  disabled?: boolean
  /** 错误信息 */
  error?: string
  /** 自定义类名 */
  className?: string
}

export const Input: React.FC<InputProps> = ({
  label,
  type = 'text',
  placeholder,
  value,
  onChange,
  required = false,
  disabled = false,
  error,
  className,
}) => {
  return (
    <div className={className}>
      {label && (
        <label className="block text-sm font-medium text-gray-700 mb-1">
          {label}
          {required && <span className="text-red-500 ml-1">*</span>}
        </label>
      )}
      <input
        type={type}
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        required={required}
        disabled={disabled}
        className={classNames(
          'block w-full px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors',
          error
            ? 'border-red-300 text-red-900 placeholder-red-300 focus:border-red-500'
            : 'border-gray-300 focus:border-primary-500',
          disabled && 'bg-gray-50 cursor-not-allowed'
        )}
      />
      {error && (
        <p className="mt-1 text-sm text-red-600">{error}</p>
      )}
    </div>
  )
}
```

#### 2.3 卡片组件

**`web/components/base/Card.tsx`**
```typescript
/**
 * 卡片组件
 * 用于内容容器
 */
import React from 'react'
import classNames from 'classnames'

interface CardProps {
  /** 卡片内容 */
  children: React.ReactNode
  /** 卡片标题 */
  title?: string
  /** 是否有边框 */
  bordered?: boolean
  /** 是否有阴影 */
  shadow?: boolean
  /** 内边距 */
  padding?: 'none' | 'sm' | 'md' | 'lg'
  /** 自定义类名 */
  className?: string
}

export const Card: React.FC<CardProps> = ({
  children,
  title,
  bordered = true,
  shadow = true,
  padding = 'md',
  className,
}) => {
  const paddingStyles = {
    none: '',
    sm: 'p-3',
    md: 'p-4',
    lg: 'p-6',
  }
  
  return (
    <div
      className={classNames(
        'bg-white rounded-lg',
        bordered && 'border border-gray-200',
        shadow && 'shadow-sm',
        paddingStyles[padding],
        className
      )}
    >
      {title && (
        <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
      )}
      {children}
    </div>
  )
}
```

---

### 步骤 3：创建 API 服务层

#### 3.1 HTTP 请求工具

**`web/utils/request.ts`**
```typescript
/**
 * HTTP 请求工具
 * 封装 axios，提供统一的请求处理
 */
import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios'
import toast from 'react-hot-toast'

/** API 响应格式 */
interface ApiResponse<T = any> {
  success: boolean
  message: string
  data?: T
}

/** 创建 axios 实例 */
const instance: AxiosInstance = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json',
  },
})

/** 请求拦截器 - 添加 Token */
instance.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('access_token')
    if (token) {
      config.headers.Authorization = `Bearer ${token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

/** 响应拦截器 - 统一错误处理 */
instance.interceptors.response.use(
  (response: AxiosResponse<ApiResponse>) => {
    return response
  },
  (error) => {
    if (error.response) {
      const { status, data } = error.response
      
      // Token 过期，跳转到登录页
      if (status === 401) {
        localStorage.removeItem('access_token')
        window.location.href = '/signin'
        toast.error('登录已过期，请重新登录')
      } else {
        // 显示错误信息
        const message = data?.message || '请求失败'
        toast.error(message)
      }
    } else {
      toast.error('网络错误，请检查连接')
    }
    
    return Promise.reject(error)
  }
)

/** 请求方法封装 */
export const request = {
  get<T = any>(url: string, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    return instance.get(url, config).then(res => res.data)
  },
  
  post<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    return instance.post(url, data, config).then(res => res.data)
  },
  
  put<T = any>(url: string, data?: any, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    return instance.put(url, data, config).then(res => res.data)
  },
  
  delete<T = any>(url: string, config?: AxiosRequestConfig): Promise<ApiResponse<T>> {
    return instance.delete(url, config).then(res => res.data)
  },
}
```

#### 3.2 认证 API 服务

**`web/service/auth.ts`**
```typescript
/**
 * 认证 API 服务
 */
import { request } from '@/utils/request'

/** 登录请求参数 */
export interface LoginParams {
  email: string
  password: string
}

/** 登录响应数据 */
export interface LoginResponse {
  access_token: string
  refresh_token: string
  expires_in: number
}

/** 注册请求参数 */
export interface RegisterParams {
  email: string
  name: string
  password: string
}

/** 用户信息 */
export interface UserInfo {
  id: string
  email: string
  name: string
  avatar?: string
  role: string
}

/** 认证服务 */
export const authService = {
  /**
   * 用户登录
   */
  login(params: LoginParams) {
    return request.post<LoginResponse>('/api/console/auth/login', params)
  },
  
  /**
   * 用户注册
   */
  register(params: RegisterParams) {
    return request.post<UserInfo>('/api/console/auth/register', params)
  },
  
  /**
   * 退出登录
   */
  logout() {
    localStorage.removeItem('access_token')
    localStorage.removeItem('refresh_token')
    window.location.href = '/signin'
  },
  
  /**
   * 获取当前用户信息
   */
  getCurrentUser() {
    return request.get<UserInfo>('/api/console/auth/me')
  },
}
```

#### 3.3 应用 API 服务

**`web/service/app.ts`**
```typescript
/**
 * 应用 API 服务
 */
import { request } from '@/utils/request'

/** 应用信息 */
export interface App {
  id: string
  name: string
  description?: string
  mode: 'chat' | 'completion' | 'agent' | 'workflow'
  icon?: string
  icon_background?: string
  status: 'draft' | 'published' | 'archived'
  created_at: string
  updated_at: string
}

/** 创建应用参数 */
export interface CreateAppParams {
  name: string
  mode: App['mode']
  description?: string
  icon?: string
}

/** 应用服务 */
export const appService = {
  /**
   * 获取应用列表
   */
  list(status?: App['status']) {
    const params = status ? { status } : {}
    return request.get<App[]>('/api/console/apps', { params })
  },
  
  /**
   * 获取应用详情
   */
  get(appId: string) {
    return request.get<App>(`/api/console/apps/${appId}`)
  },
  
  /**
   * 创建应用
   */
  create(params: CreateAppParams) {
    return request.post<App>('/api/console/apps', params)
  },
  
  /**
   * 更新应用
   */
  update(appId: string, params: Partial<CreateAppParams>) {
    return request.put<App>(`/api/console/apps/${appId}`, params)
  },
  
  /**
   * 删除应用
   */
  delete(appId: string) {
    return request.delete(`/api/console/apps/${appId}`)
  },
}
```

---

### 步骤 4：创建页面

#### 4.1 登录页面

**`web/app/(auth)/signin/page.tsx`**
```typescript
/**
 * 登录页面
 */
'use client'

import React, { useState } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { Input } from '@/components/base/Input'
import { Button } from '@/components/base/Button'
import { Card } from '@/components/base/Card'
import { authService } from '@/service/auth'
import toast from 'react-hot-toast'

export default function SignInPage() {
  const router = useRouter()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // 表单验证
    if (!email || !password) {
      toast.error('请填写所有字段')
      return
    }
    
    setLoading(true)
    
    try {
      const response = await authService.login({ email, password })
      
      if (response.success && response.data) {
        // 保存 Token
        localStorage.setItem('access_token', response.data.access_token)
        localStorage.setItem('refresh_token', response.data.refresh_token)
        
        toast.success('登录成功')
        router.push('/apps')
      }
    } catch (error) {
      // 错误已在拦截器中处理
    } finally {
      setLoading(false)
    }
  }
  
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        {/* Logo 和标题 */}
        <div className="text-center">
          <h2 className="text-3xl font-bold text-gray-900">
            {process.env.NEXT_PUBLIC_APP_NAME}
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            登录您的账户
          </p>
        </div>
        
        {/* 登录表单 */}
        <Card className="mt-8">
          <form onSubmit={handleSubmit} className="space-y-6">
            <Input
              label="邮箱地址"
              type="email"
              placeholder="your@email.com"
              value={email}
              onChange={setEmail}
              required
            />
            
            <Input
              label="密码"
              type="password"
              placeholder="••••••••"
              value={password}
              onChange={setPassword}
              required
            />
            
            <Button
              type="submit"
              variant="primary"
              className="w-full"
              loading={loading}
            >
              登录
            </Button>
          </form>
          
          <div className="mt-4 text-center text-sm">
            <span className="text-gray-600">还没有账户？</span>
            {' '}
            <Link href="/signup" className="text-primary-600 hover:text-primary-700 font-medium">
              立即注册
            </Link>
          </div>
        </Card>
      </div>
    </div>
  )
}
```

#### 4.2 应用列表页面

**`web/app/(commonLayout)/apps/page.tsx`**
```typescript
/**
 * 应用列表页面
 */
'use client'

import React, { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'
import { Button } from '@/components/base/Button'
import { Card } from '@/components/base/Card'
import { appService, App } from '@/service/app'
import toast from 'react-hot-toast'

export default function AppsPage() {
  const router = useRouter()
  const [apps, setApps] = useState<App[]>([])
  const [loading, setLoading] = useState(true)
  
  useEffect(() => {
    loadApps()
  }, [])
  
  const loadApps = async () => {
    try {
      const response = await appService.list()
      if (response.success && response.data) {
        setApps(response.data)
      }
    } catch (error) {
      // 错误已处理
    } finally {
      setLoading(false)
    }
  }
  
  const handleCreateApp = () => {
    router.push('/apps/new')
  }
  
  const handleAppClick = (appId: string) => {
    router.push(`/apps/${appId}`)
  }
  
  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-500">加载中...</div>
      </div>
    )
  }
  
  return (
    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* 页面头部 */}
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">我的应用</h1>
          <p className="mt-1 text-sm text-gray-600">
            创建和管理您的 AI 应用
          </p>
        </div>
        <Button onClick={handleCreateApp}>
          + 创建应用
        </Button>
      </div>
      
      {/* 应用列表 */}
      {apps.length === 0 ? (
        <Card className="text-center py-12">
          <p className="text-gray-500 mb-4">还没有应用</p>
          <Button onClick={handleCreateApp}>
            创建第一个应用
          </Button>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {apps.map((app) => (
            <Card
              key={app.id}
              className="cursor-pointer hover:shadow-md transition-shadow"
              onClick={() => handleAppClick(app.id)}
            >
              <div className="flex items-start space-x-3">
                {/* 应用图标 */}
                <div
                  className="flex-shrink-0 w-12 h-12 rounded-lg flex items-center justify-center text-white text-xl font-bold"
                  style={{ backgroundColor: app.icon_background || '#6366f1' }}
                >
                  {app.icon || app.name.charAt(0)}
                </div>
                
                {/* 应用信息 */}
                <div className="flex-1 min-w-0">
                  <h3 className="text-lg font-semibold text-gray-900 truncate">
                    {app.name}
                  </h3>
                  <p className="text-sm text-gray-500 line-clamp-2">
                    {app.description || '暂无描述'}
                  </p>
                  <div className="mt-2 flex items-center space-x-2">
                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                      {app.mode}
                    </span>
                    <span className="text-xs text-gray-400">
                      {new Date(app.updated_at).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              </div>
            </Card>
          ))}
        </div>
      )}
    </div>
  )
}
```

---

### 步骤 5：创建布局组件

#### 5.1 认证布局

**`web/app/(auth)/layout.tsx`**
```typescript
/**
 * 认证页面布局
 * 用于登录、注册等页面
 */
import React from 'react'

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen bg-gray-50">
      {children}
    </div>
  )
}
```

#### 5.2 通用布局（带侧边栏）

**`web/app/(commonLayout)/layout.tsx`**
```typescript
/**
 * 通用布局
 * 包含顶部导航栏和侧边栏
 */
'use client'

import React, { useState } from 'react'
import Link from 'next/link'
import { usePathname, useRouter } from 'next/navigation'
import { authService } from '@/service/auth'
import classNames from 'classnames'

export default function CommonLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const pathname = usePathname()
  const router = useRouter()
  const [sidebarOpen, setSidebarOpen] = useState(true)
  
  const navigation = [
    { name: '应用', href: '/apps', icon: '🚀' },
    { name: '数据集', href: '/datasets', icon: '📚' },
    { name: '工作空间', href: '/workspace', icon: '⚙️' },
  ]
  
  const handleLogout = () => {
    authService.logout()
  }
  
  return (
    <div className="min-h-screen bg-gray-50">
      {/* 侧边栏 */}
      <div
        className={classNames(
          'fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-200 ease-in-out',
          sidebarOpen ? 'translate-x-0' : '-translate-x-full'
        )}
      >
        {/* Logo */}
        <div className="h-16 flex items-center px-6 border-b border-gray-200">
          <h1 className="text-xl font-bold text-gray-900">
            {process.env.NEXT_PUBLIC_APP_NAME}
          </h1>
        </div>
        
        {/* 导航菜单 */}
        <nav className="mt-6 px-3">
          {navigation.map((item) => {
            const isActive = pathname.startsWith(item.href)
            return (
              <Link
                key={item.name}
                href={item.href}
                className={classNames(
                  'flex items-center px-3 py-2 mb-1 rounded-lg text-sm font-medium transition-colors',
                  isActive
                    ? 'bg-primary-50 text-primary-600'
                    : 'text-gray-700 hover:bg-gray-100'
                )}
              >
                <span className="mr-3 text-lg">{item.icon}</span>
                {item.name}
              </Link>
            )
          })}
        </nav>
        
        {/* 底部用户信息 */}
        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
          <button
            onClick={handleLogout}
            className="w-full px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
          >
            退出登录
          </button>
        </div>
      </div>
      
      {/* 主内容区 */}
      <div className={classNames(
        'transition-all duration-200 ease-in-out',
        sidebarOpen ? 'ml-64' : 'ml-0'
      )}>
        {/* 顶部栏 */}
        <header className="h-16 bg-white border-b border-gray-200 flex items-center px-6">
          <button
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="text-gray-500 hover:text-gray-700"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </header>
        
        {/* 页面内容 */}
        <main className="p-6">
          {children}
        </main>
      </div>
    </div>
  )
}
```

---

## 品牌自定义指南

### 替换 Logo
1. 将 Logo 文件放到 `public/logo/` 目录
2. 在布局组件中引用：
```typescript
import Image from 'next/image'

<Image src="/logo/your-logo.png" alt="Logo" width={120} height={40} />
```

### 自定义主题色
修改 `tailwind.config.js` 中的 `primary` 颜色配置

### 修改应用名称
在 `.env` 文件中修改：
```env
NEXT_PUBLIC_APP_NAME=您的应用名称
```

---

## 开发检查清单

- [ ] 所有组件使用 TypeScript
- [ ] 注释使用中文
- [ ] 响应式设计实现
- [ ] 错误处理完善
- [ ] Loading 状态展示
- [ ] 无障碍支持（a11y）
- [ ] 性能优化（代码分割）


## 下一步

完成前端开发后，进入：
👉 **阶段五：简化并优化 Docker 部署配置**
