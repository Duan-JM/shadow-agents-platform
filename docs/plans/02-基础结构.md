# 阶段二：创建项目基础结构

## 目标
基于阶段一的分析结果，搭建新项目的目录结构和基础配置文件，为后续开发工作准备好框架。

---

## 总体思路

### 设计原则
1. **模块化**：清晰的模块划分，便于维护
2. **简洁性**：去除非必要的复杂性
3. **可配置**：支持灵活的配置管理
4. **中文化**：所有文档和注释使用中文

### 项目命名
建议项目名称：**Shadow Agents Platform**（影子智能体平台）

---

## 详细执行步骤

### 步骤 1：创建顶层目录结构

#### 1.1 目录规划
```
shadow-agents-platform/
├── api/                      # 后端 API 服务
├── web/                      # 前端 Web 应用
├── docker/                   # Docker 配置
├── docs/                     # 项目文档
├── scripts/                  # 脚本工具
├── .gitignore               # Git 忽略文件
├── .editorconfig            # 编辑器配置
├── LICENSE                  # 开源协议
├── README.md                # 项目说明
└── CHANGELOG.md             # 变更日志
```

#### 1.2 执行动作
```bash
# 创建主要目录
mkdir -p api web docker docs scripts
mkdir -p docs/{architecture,plans,guides,api-reference}

# 创建子目录
mkdir -p docker/{nginx,postgres,redis,volumes}
mkdir -p scripts/{deployment,development,migration}
```

---

### 步骤 2：创建后端基础结构

#### 2.1 API 目录结构
```
api/
├── app.py                    # 应用入口
├── app_factory.py            # Flask 应用工厂
├── requirements.txt          # 依赖列表（简化版）
├── pyproject.toml           # 项目配置
├── .env.example             # 环境变量示例
├── Dockerfile               # Docker 镜像构建
├── configs/                 # 配置模块
│   ├── __init__.py
│   ├── app_config.py       # 应用配置
│   ├── db_config.py        # 数据库配置
│   └── middleware_config.py # 中间件配置
├── controllers/             # 控制器层（API 路由）
│   ├── __init__.py
│   ├── console/            # 控制台 API
│   │   ├── __init__.py
│   │   ├── auth/           # 认证相关
│   │   ├── app/            # 应用管理
│   │   ├── workspace/      # 工作空间
│   │   └── dataset/        # 数据集管理
│   └── service/            # 服务 API
│       ├── __init__.py
│       ├── completion/     # 对话完成
│       └── workflow/       # 工作流执行
├── core/                    # 核心业务逻辑
│   ├── __init__.py
│   ├── app/                # 应用核心
│   │   ├── __init__.py
│   │   ├── entities/       # 实体定义
│   │   ├── features/       # 功能模块
│   │   └── runners/        # 执行器
│   ├── workflow/           # 工作流引擎
│   │   ├── __init__.py
│   │   ├── nodes/          # 工作流节点
│   │   ├── engine/         # 执行引擎
│   │   └── graph/          # 图处理
│   ├── rag/                # 检索增强生成
│   │   ├── __init__.py
│   │   ├── datasource/     # 数据源
│   │   ├── retrieval/      # 检索
│   │   └── embedding/      # 向量化
│   └── model_runtime/      # 模型运行时
│       ├── __init__.py
│       ├── providers/      # 模型提供商
│       └── entities/       # 模型实体
├── models/                  # 数据模型（ORM）
│   ├── __init__.py
│   ├── account.py          # 用户账户
│   ├── app.py              # 应用
│   ├── workflow.py         # 工作流
│   ├── dataset.py          # 数据集
│   └── message.py          # 消息
├── services/                # 服务层
│   ├── __init__.py
│   ├── auth_service.py     # 认证服务
│   ├── app_service.py      # 应用服务
│   ├── workflow_service.py # 工作流服务
│   └── dataset_service.py  # 数据集服务
├── repositories/            # 数据访问层
│   ├── __init__.py
│   └── base_repository.py
├── extensions/              # 扩展模块
│   ├── __init__.py
│   ├── ext_database.py     # 数据库扩展
│   ├── ext_redis.py        # Redis 扩展
│   └── ext_storage.py      # 存储扩展
├── libs/                    # 工具库
│   ├── __init__.py
│   ├── helper.py           # 辅助函数
│   └── errors.py           # 错误处理
├── tasks/                   # 异步任务
│   ├── __init__.py
│   └── celery_app.py
├── migrations/              # 数据库迁移
│   └── versions/
└── tests/                   # 测试代码
    ├── __init__.py
    └── unit/
```

#### 2.2 执行动作
```bash
cd api

# 创建所有目录
mkdir -p configs controllers/{console/{auth,app,workspace,dataset},service/{completion,workflow}}
mkdir -p core/{app/{entities,features,runners},workflow/{nodes,engine,graph},rag/{datasource,retrieval,embedding},model_runtime/{providers,entities}}
mkdir -p models services repositories extensions libs tasks migrations/versions tests/unit

# 创建 __init__.py 文件
find . -type d -exec touch {}/__init__.py \;
```

---

### 步骤 3：创建前端基础结构

#### 3.1 Web 目录结构
```
web/
├── app/                      # Next.js App Router
│   ├── (auth)/              # 认证相关页面
│   │   ├── signin/
│   │   ├── signup/
│   │   └── layout.tsx
│   ├── (commonLayout)/      # 通用布局页面
│   │   ├── apps/           # 应用列表
│   │   ├── workspace/      # 工作空间
│   │   ├── datasets/       # 数据集
│   │   └── layout.tsx
│   ├── install/            # 安装向导
│   ├── layout.tsx          # 根布局
│   └── page.tsx            # 首页
├── components/              # 公共组件
│   ├── base/               # 基础组件
│   ├── app/                # 应用相关组件
│   ├── workflow/           # 工作流组件
│   └── dataset/            # 数据集组件
├── context/                 # React Context
│   ├── app-context.tsx
│   └── workflow-context.tsx
├── hooks/                   # 自定义 Hooks
│   ├── use-auth.ts
│   └── use-workflow.ts
├── service/                 # API 服务
│   ├── base.ts
│   ├── auth.ts
│   ├── app.ts
│   └── workflow.ts
├── models/                  # 数据模型和类型
│   ├── app.ts
│   └── workflow.ts
├── types/                   # TypeScript 类型
│   └── index.ts
├── utils/                   # 工具函数
│   ├── request.ts
│   └── format.ts
├── i18n/                    # 国际化
│   ├── zh-Hans.ts          # 简体中文
│   └── en-US.ts            # 英文
├── styles/                  # 样式文件
│   └── globals.css
├── public/                  # 静态资源
│   ├── logo/               # Logo 文件
│   └── icons/              # 图标
├── config/                  # 配置文件
│   └── index.ts
├── package.json            # 依赖配置
├── tsconfig.json           # TypeScript 配置
├── tailwind.config.js      # Tailwind 配置
├── next.config.js          # Next.js 配置
├── .env.example            # 环境变量示例
└── Dockerfile              # Docker 镜像构建
```

#### 3.2 执行动作
```bash
cd web

# 创建目录结构
mkdir -p app/{auth/{signin,signup},commonLayout/{apps,workspace,datasets},install}
mkdir -p components/{base,app,workflow,dataset}
mkdir -p context hooks service models types utils
mkdir -p i18n styles public/{logo,icons} config
```

---

### 步骤 4：创建 Docker 配置

#### 4.1 Docker 目录结构
```
docker/
├── docker-compose.yml       # 主配置文件
├── .env.example            # 环境变量示例
├── nginx/                  # Nginx 配置
│   ├── nginx.conf
│   └── conf.d/
│       └── default.conf
├── postgres/               # PostgreSQL 配置
│   └── init.sql
├── redis/                  # Redis 配置
│   └── redis.conf
└── volumes/                # 数据卷挂载点
    ├── postgres/
    ├── redis/
    └── storage/
```

#### 4.2 执行动作
```bash
cd docker

# 创建配置目录
mkdir -p nginx/conf.d postgres redis
mkdir -p volumes/{postgres,redis,storage}
```

---

### 步骤 5：创建配置文件

#### 5.1 根目录配置文件

**`.gitignore`**
```gitignore
# Python
__pycache__/
*.py[cod]
*.so
.Python
venv/
env/
*.egg-info/

# Node
node_modules/
.next/
out/
*.log

# 环境变量
.env
.env.local

# IDE
.vscode/
.idea/
*.swp

# Docker
docker/volumes/

# 系统文件
.DS_Store
Thumbs.db
```

**`.editorconfig`**
```ini
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{py,js,ts,tsx,json,yml,yaml}]
indent_style = space
indent_size = 2

[*.py]
indent_size = 4

[*.md]
trim_trailing_whitespace = false
```

**`README.md`**
```markdown
# Shadow Agents Platform

影子智能体平台 - 一个强大的 AI 应用开发平台

## 简介

Shadow Agents Platform 是一个开源的 AI 应用开发平台，支持快速构建和部署 AI 应用。

## 功能特性

- 🤖 多种应用类型支持（聊天助手、文本生成、Agent、工作流）
- 🔧 可视化工作流设计器
- 📚 知识库和 RAG 支持
- 🎨 简洁易用的界面
- 🐳 简化的 Docker 部署

## 快速开始

详见 [部署指南](docs/guides/deployment.md)

## 技术栈

### 后端
- Python 3.11+
- Flask
- SQLAlchemy
- Celery

### 前端
- React 18+
- Next.js 14+
- TypeScript
- Tailwind CSS

## 文档

- [架构设计](docs/architecture/)
- [部署指南](docs/guides/deployment.md)
- [开发指南](docs/guides/development.md)
- [API 文档](docs/api-reference/)

## 许可证

MIT License

## 自定义品牌

本平台支持完全自定义品牌元素，详见 [品牌定制指南](docs/guides/branding.md)
```

#### 5.2 执行动作
```bash
# 在根目录创建配置文件
cat > .gitignore << 'EOF'
# 内容如上
EOF

cat > .editorconfig << 'EOF'
# 内容如上
EOF

cat > README.md << 'EOF'
# 内容如上
EOF
```

---

### 步骤 6：初始化基础代码文件

#### 6.1 后端基础文件

**`api/app.py`**
```python
"""
应用入口文件
"""
from app_factory import create_app

# 创建 Flask 应用实例
app = create_app()

if __name__ == "__main__":
    # 开发模式运行
    app.run(host="0.0.0.0", port=5001, debug=True)
```

**`api/app_factory.py`**
```python
"""
Flask 应用工厂
用于创建和配置 Flask 应用实例
"""
from flask import Flask
from flask_cors import CORS

def create_app() -> Flask:
    """
    创建 Flask 应用实例
    
    Returns:
        Flask: 配置好的 Flask 应用
    """
    app = Flask(__name__)
    
    # 加载配置
    app.config.from_object('configs.app_config')
    
    # 初始化扩展
    initialize_extensions(app)
    
    # 注册蓝图
    register_blueprints(app)
    
    # 注册错误处理
    register_error_handlers(app)
    
    return app

def initialize_extensions(app: Flask) -> None:
    """初始化 Flask 扩展"""
    # CORS
    CORS(app)
    
    # 数据库
    # 将在后续步骤中实现
    pass

def register_blueprints(app: Flask) -> None:
    """注册蓝图（路由）"""
    # 将在后续步骤中实现
    pass

def register_error_handlers(app: Flask) -> None:
    """注册错误处理器"""
    # 将在后续步骤中实现
    pass
```

**`api/pyproject.toml`**
```toml
[project]
name = "shadow-agents-api"
version = "0.1.0"
description = "Shadow Agents Platform API"
requires-python = ">=3.11"

dependencies = [
    "flask>=3.0.0",
    "flask-cors>=4.0.0",
    "flask-sqlalchemy>=3.1.0",
    "sqlalchemy>=2.0.0",
    "celery>=5.3.0",
    "redis>=5.0.0",
    "psycopg2-binary>=2.9.0",
    "python-dotenv>=1.0.0",
]

[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"
```

#### 6.2 前端基础文件

**`web/package.json`**
```json
{
  "name": "shadow-agents-web",
  "version": "0.1.0",
  "description": "Shadow Agents Platform Web",
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "next": "^14.0.0",
    "typescript": "^5.0.0",
    "tailwindcss": "^3.4.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0"
  }
}
```

**`web/next.config.js`**
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true,
  // 环境变量
  env: {
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5001',
  },
}

module.exports = nextConfig
```

**`web/tsconfig.json`**
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

---

### 步骤 7：创建 Docker 配置文件

**`docker/docker-compose.yml`**
```yaml
version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: shadow-postgres
    environment:
      POSTGRES_DB: shadow_agents
      POSTGRES_USER: shadow
      POSTGRES_PASSWORD: shadow123456
    volumes:
      - ./volumes/postgres:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U shadow"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: shadow-redis
    command: redis-server --requirepass shadow123456
    volumes:
      - ./volumes/redis:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API 后端
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: shadow-api
    environment:
      - DATABASE_URL=postgresql://shadow:shadow123456@postgres:5432/shadow_agents
      - REDIS_URL=redis://:shadow123456@redis:6379/0
      - SECRET_KEY=change-this-secret-key
    volumes:
      - ../api:/app
      - ./volumes/storage:/app/storage
    ports:
      - "5001:5001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: python app.py

  # Web 前端
  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    container_name: shadow-web
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:5001
    ports:
      - "3000:3000"
    depends_on:
      - api
    command: npm run dev

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: shadow-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    ports:
      - "80:80"
    depends_on:
      - api
      - web

volumes:
  postgres:
  redis:
  storage:
```

---

## 验证检查清单

完成基础结构创建后，需要验证：

- [ ] 所有目录结构已创建
- [ ] 基础配置文件已就位
- [ ] Python 环境可以初始化（虚拟环境）
- [ ] Node.js 依赖可以安装
- [ ] Docker Compose 配置语法正确
- [ ] Git 仓库已初始化
- [ ] README 文档内容清晰

---

## 下一步

完成基础结构后，进入：
👉 **阶段三：复刻 API 后端核心功能**
