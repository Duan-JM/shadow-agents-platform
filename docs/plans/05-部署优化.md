# 阶段五：简化并优化 Docker 部署配置

## 目标
基于 Dify 的 Docker 配置，创建简化版的部署方案，降低部署难度，提供清晰的部署文档和配置说明。

---

## 总体思路

### 简化策略
1. **减少服务数量**：合并非必要的服务
2. **统一配置**：使用单一配置文件
3. **预设默认值**：提供开箱即用的配置
4. **清晰文档**：详细的部署说明
5. **一键部署**：提供快速启动脚本

### 核心服务
```
必需服务：
- API (后端应用)
- Web (前端应用)
- PostgreSQL (数据库)
- Redis (缓存)
- Nginx (反向代理)

可选服务：
- Vector DB (向量数据库，用于 RAG)
- Worker (异步任务处理)
```

---

## 详细执行步骤

### 步骤 1：简化 Docker Compose 配置

#### 1.1 主配置文件

**`docker/docker-compose.yml`**
```yaml
version: '3.8'

# 网络配置
networks:
  shadow-network:
    driver: bridge

# 数据卷配置
volumes:
  postgres-data:
  redis-data:
  storage-data:

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    container_name: shadow-postgres
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      POSTGRES_DB: ${DB_DATABASE:-shadow_agents}
      POSTGRES_USER: ${DB_USERNAME:-shadow}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-shadow123456}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-shadow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: shadow-redis
    restart: unless-stopped
    networks:
      - shadow-network
    command: redis-server --requirepass ${REDIS_PASSWORD:-shadow123456} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API 后端服务
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: shadow-api
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      # 数据库配置
      DB_USERNAME: ${DB_USERNAME:-shadow}
      DB_PASSWORD: ${DB_PASSWORD:-shadow123456}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-shadow_agents}
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-shadow123456}
      # 应用配置
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      FLASK_ENV: ${FLASK_ENV:-production}
      DEBUG: ${DEBUG:-false}
      # CORS 配置
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-*}
    volumes:
      - storage-data:/app/storage
      - ../api:/app
    ports:
      - "${API_PORT:-5001}:5001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: gunicorn --bind 0.0.0.0:5001 --workers 2 --timeout 120 app:app

  # Worker 服务（异步任务，可选）
  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: shadow-worker
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      # 数据库配置
      DB_USERNAME: ${DB_USERNAME:-shadow}
      DB_PASSWORD: ${DB_PASSWORD:-shadow123456}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-shadow_agents}
      # Redis 配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-shadow123456}
      # 应用配置
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
    volumes:
      - storage-data:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.celery worker --loglevel=info
    profiles:
      - full  # 只在 full profile 下启动

  # Web 前端服务
  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    container_name: shadow-web
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      NEXT_PUBLIC_API_URL: ${API_URL:-http://localhost/api}
      NEXT_PUBLIC_APP_NAME: ${APP_NAME:-Shadow Agents Platform}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - api

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: shadow-nginx
    restart: unless-stopped
    networks:
      - shadow-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "${NGINX_PORT:-80}:80"
    depends_on:
      - api
      - web
```

#### 1.2 环境变量配置

**`docker/.env.example`**
```env
# ================================
# Shadow Agents Platform 配置文件
# ================================

# 应用信息
APP_NAME=Shadow Agents Platform
APP_VERSION=0.1.0

# 数据库配置
DB_USERNAME=shadow
DB_PASSWORD=shadow123456
DB_DATABASE=shadow_agents
DB_PORT=5432

# Redis 配置
REDIS_PASSWORD=shadow123456
REDIS_PORT=6379

# 应用密钥（生产环境请务必修改！）
SECRET_KEY=change-this-secret-key-in-production

# Flask 环境
FLASK_ENV=production
DEBUG=false

# API 配置
API_PORT=5001
API_URL=http://localhost/api

# Web 配置
WEB_PORT=3000

# Nginx 配置
NGINX_PORT=80

# CORS 配置
CORS_ALLOW_ORIGINS=*

# ================================
# 可选配置（高级用户）
# ================================

# 数据库连接池配置
SQLALCHEMY_POOL_SIZE=30
SQLALCHEMY_MAX_OVERFLOW=10

# JWT 配置
JWT_ACCESS_TOKEN_EXPIRES=3600
JWT_REFRESH_TOKEN_EXPIRES=2592000

# 文件存储配置
STORAGE_TYPE=local
STORAGE_LOCAL_PATH=./storage
```

---

### 步骤 2：创建 Dockerfile

#### 2.1 API Dockerfile

**`api/Dockerfile`**
```dockerfile
# ==============================
# Shadow Agents Platform - API
# ==============================

FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY pyproject.toml ./

# 安装 Python 依赖
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -e .

# 复制应用代码
COPY . .

# 创建存储目录
RUN mkdir -p storage

# 暴露端口
EXPOSE 5001

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5001/health || exit 1

# 启动命令（在 docker-compose 中覆盖）
CMD ["gunicorn", "--bind", "0.0.0.0:5001", "--workers", "2", "--timeout", "120", "app:app"]
```

#### 2.2 Web Dockerfile

**`web/Dockerfile`**
```dockerfile
# ==============================
# Shadow Agents Platform - Web
# ==============================

FROM node:18-alpine AS base

# 安装依赖阶段
FROM base AS deps
WORKDIR /app

# 复制依赖文件
COPY package.json package-lock.json* ./
RUN npm ci

# 构建阶段
FROM base AS builder
WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

# 构建应用
RUN npm run build

# 运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

# 创建非 root 用户
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# 复制构建产物
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# 启动命令
CMD ["node", "server.js"]
```

---

### 步骤 3：Nginx 配置

#### 3.1 主配置文件

**`docker/nginx/nginx.conf`**
```nginx
# Shadow Agents Platform - Nginx 配置

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # 包含站点配置
    include /etc/nginx/conf.d/*.conf;
}
```

#### 3.2 站点配置

**`docker/nginx/conf.d/default.conf`**
```nginx
# Shadow Agents Platform - 站点配置

# API 上游服务器
upstream api_backend {
    server api:5001;
}

# Web 上游服务器
upstream web_backend {
    server web:3000;
}

server {
    listen 80;
    server_name _;

    # 客户端请求体大小限制
    client_max_body_size 100M;

    # API 路由
    location /api/ {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        
        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # 缓冲设置
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # Web 前端路由
    location / {
        proxy_pass http://web_backend;
        proxy_http_version 1.1;
        
        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # 健康检查端点
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
```

---

### 步骤 4：创建部署脚本

#### 4.1 一键启动脚本

**`docker/start.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform 启动脚本
# ====================================

set -e

echo "========================================="
echo "  Shadow Agents Platform"
echo "  正在启动..."
echo "========================================="

# 检查 Docker 和 Docker Compose
if ! command -v docker &> /dev/null; then
    echo "错误: 未安装 Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "错误: 未安装 Docker Compose"
    exit 1
fi

# 进入脚本所在目录
cd "$(dirname "$0")"

# 检查环境变量文件
if [ ! -f ".env" ]; then
    echo "未找到 .env 文件，从示例创建..."
    cp .env.example .env
    echo "✓ 已创建 .env 文件"
    echo ""
    echo "警告: 请修改 .env 文件中的密钥配置！"
    echo "特别是 SECRET_KEY、DB_PASSWORD 和 REDIS_PASSWORD"
    echo ""
fi

# 选择部署模式
echo "选择部署模式:"
echo "1) 标准模式 (API + Web + 数据库)"
echo "2) 完整模式 (包含 Worker 异步任务)"
read -p "请选择 [1/2]: " mode

case $mode in
    2)
        echo "启动完整模式..."
        docker-compose --profile full up -d
        ;;
    *)
        echo "启动标准模式..."
        docker-compose up -d
        ;;
esac

# 等待服务启动
echo ""
echo "等待服务启动..."
sleep 5

# 检查服务状态
echo ""
echo "========================================="
echo "  服务状态"
echo "========================================="
docker-compose ps

# 显示访问信息
echo ""
echo "========================================="
echo "  部署完成！"
echo "========================================="
echo ""
echo "访问地址:"
echo "  - 前端: http://localhost"
echo "  - API:  http://localhost/api"
echo ""
echo "默认端口:"
echo "  - Nginx:      80"
echo "  - API:        5001"
echo "  - Web:        3000"
echo "  - PostgreSQL: 5432"
echo "  - Redis:      6379"
echo ""
echo "查看日志: docker-compose logs -f"
echo "停止服务: docker-compose down"
echo ""
```

#### 4.2 停止脚本

**`docker/stop.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform 停止脚本
# ====================================

set -e

cd "$(dirname "$0")"

echo "正在停止 Shadow Agents Platform..."

docker-compose down

echo "服务已停止"
```

#### 4.3 重启脚本

**`docker/restart.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform 重启脚本
# ====================================

set -e

cd "$(dirname "$0")"

echo "正在重启 Shadow Agents Platform..."

docker-compose restart

echo "服务已重启"
```

#### 4.4 给脚本添加执行权限

```bash
chmod +x docker/start.sh
chmod +x docker/stop.sh
chmod +x docker/restart.sh
```

---

### 步骤 5：数据库初始化脚本

**`docker/postgres/init.sql`**
```sql
-- ====================================
-- Shadow Agents Platform
-- 数据库初始化脚本
-- ====================================

-- 创建必要的扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 设置时区
SET timezone = 'UTC';

-- 创建数据库（如果不存在）
-- 注意: Docker 已通过环境变量创建数据库，此处为备用

-- 输出版本信息
SELECT version();

-- 完成
\echo '数据库初始化完成'
```

---

### 步骤 6：创建部署文档

**`docs/guides/deployment.md`**
````markdown
# 部署指南

Shadow Agents Platform 提供了简化的 Docker 部署方案，支持快速启动和运维。

---

## 系统要求

### 最低配置
- CPU: 2 核心
- 内存: 4GB RAM
- 磁盘: 20GB 可用空间
- 操作系统: Linux / macOS / Windows (with WSL2)

### 推荐配置
- CPU: 4 核心
- 内存: 8GB RAM
- 磁盘: 50GB 可用空间

### 软件要求
- Docker 20.10+
- Docker Compose 2.0+

---

## 快速开始

### 1. 克隆仓库

```bash
git clone https://github.com/your-org/shadow-agents-platform.git
cd shadow-agents-platform
```

### 2. 配置环境变量

```bash
cd docker
cp .env.example .env
```

编辑 `.env` 文件，至少修改以下配置：

```env
# 应用密钥（必须修改！）
SECRET_KEY=your-secret-key-here

# 数据库密码
DB_PASSWORD=your-secure-password

# Redis 密码
REDIS_PASSWORD=your-secure-password
```

### 3. 启动服务

```bash
# 使用一键启动脚本
./start.sh

# 或手动启动
docker-compose up -d
```

### 4. 访问应用

打开浏览器访问: http://localhost

默认会进入安装向导，按提示创建管理员账户。

---

## 部署模式

### 标准模式（推荐）

包含核心服务，适合大多数场景：

```bash
docker-compose up -d
```

服务列表：
- API (后端)
- Web (前端)
- PostgreSQL (数据库)
- Redis (缓存)
- Nginx (反向代理)

### 完整模式

包含所有服务，支持异步任务处理：

```bash
docker-compose --profile full up -d
```

额外服务：
- Worker (Celery 异步任务)

---

## 常用命令

### 查看服务状态

```bash
docker-compose ps
```

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f api
docker-compose logs -f web
```

### 停止服务

```bash
docker-compose down
```

### 重启服务

```bash
docker-compose restart
```

### 更新服务

```bash
# 拉取最新代码
git pull

# 重新构建并启动
docker-compose up -d --build
```

---

## 数据备份

### 备份数据库

```bash
docker exec shadow-postgres pg_dump -U shadow shadow_agents > backup.sql
```

### 恢复数据库

```bash
docker exec -i shadow-postgres psql -U shadow shadow_agents < backup.sql
```

### 备份文件存储

```bash
docker run --rm -v shadow-agents-platform_storage-data:/data -v $(pwd):/backup alpine tar czf /backup/storage-backup.tar.gz /data
```

---

## 故障排查

### 服务无法启动

1. 检查端口占用：
```bash
netstat -tulpn | grep -E '80|3000|5001|5432|6379'
```

2. 检查 Docker 资源：
```bash
docker system df
```

3. 查看详细日志：
```bash
docker-compose logs
```

### 数据库连接失败

1. 检查数据库服务状态：
```bash
docker-compose ps postgres
```

2. 测试数据库连接：
```bash
docker exec shadow-postgres pg_isready -U shadow
```

### API 无响应

1. 检查 API 日志：
```bash
docker-compose logs api
```

2. 进入容器调试：
```bash
docker exec -it shadow-api bash
```

---

## 生产环境建议

### 1. 使用 HTTPS

配置 SSL 证书，使用 Let's Encrypt：

```bash
# 安装 certbot
apt-get install certbot

# 获取证书
certbot certonly --standalone -d yourdomain.com
```

更新 Nginx 配置以支持 HTTPS。

### 2. 修改默认密码

确保修改所有默认密码：
- SECRET_KEY
- DB_PASSWORD
- REDIS_PASSWORD

### 3. 启用防火墙

```bash
# 只开放必要端口
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 4. 定期备份

设置定时任务备份数据库和文件。

### 5. 资源监控

使用工具监控服务状态：
- Docker stats
- Prometheus + Grafana
- 云服务商监控

---

## 升级指南

### 小版本升级

```bash
git pull
docker-compose up -d --build
```

### 大版本升级

1. 备份数据
2. 查看更新日志 (CHANGELOG.md)
3. 执行迁移脚本（如有）
4. 更新配置文件
5. 重新构建和启动

---

## 获取帮助

- 查看文档: `docs/`
- 提交 Issue: GitHub Issues
- 社区讨论: GitHub Discussions

---
````

---

## 简化对比

### Dify 原配置
- 1375 行 Docker Compose 配置
- 100+ 环境变量
- 多个可选中间件（Elasticsearch、向量数据库等）
- 复杂的网络和卷配置

### Shadow 简化版
- ~200 行 Docker Compose 配置
- ~30 个核心环境变量
- 只保留必需服务
- 预设合理默认值
- 提供一键启动脚本

---

## 验证检查清单

- [ ] Docker Compose 配置语法正确
- [ ] 环境变量配置完整
- [ ] Dockerfile 构建成功
- [ ] Nginx 配置正确
- [ ] 启动脚本可执行
- [ ] 服务健康检查有效
- [ ] 数据持久化正常
- [ ] 部署文档清晰

---

## 下一步

完成部署配置后，进入：
👉 **阶段六：移除作者信息和品牌元素**
