# é˜¶æ®µäº”ï¼šç®€åŒ–å¹¶ä¼˜åŒ– Docker éƒ¨ç½²é…ç½®

## ç›®æ ‡
åŸºäº Dify çš„ Docker é…ç½®ï¼Œåˆ›å»ºç®€åŒ–ç‰ˆçš„éƒ¨ç½²æ–¹æ¡ˆï¼Œé™ä½éƒ¨ç½²éš¾åº¦ï¼Œæä¾›æ¸…æ™°çš„éƒ¨ç½²æ–‡æ¡£å’Œé…ç½®è¯´æ˜ã€‚

---

## æ€»ä½“æ€è·¯

### ç®€åŒ–ç­–ç•¥
1. **å‡å°‘æœåŠ¡æ•°é‡**ï¼šåˆå¹¶éå¿…è¦çš„æœåŠ¡
2. **ç»Ÿä¸€é…ç½®**ï¼šä½¿ç”¨å•ä¸€é…ç½®æ–‡ä»¶
3. **é¢„è®¾é»˜è®¤å€¼**ï¼šæä¾›å¼€ç®±å³ç”¨çš„é…ç½®
4. **æ¸…æ™°æ–‡æ¡£**ï¼šè¯¦ç»†çš„éƒ¨ç½²è¯´æ˜
5. **ä¸€é”®éƒ¨ç½²**ï¼šæä¾›å¿«é€Ÿå¯åŠ¨è„šæœ¬

### æ ¸å¿ƒæœåŠ¡
```
å¿…éœ€æœåŠ¡ï¼š
- API (åç«¯åº”ç”¨)
- Web (å‰ç«¯åº”ç”¨)
- PostgreSQL (æ•°æ®åº“)
- Redis (ç¼“å­˜)
- Nginx (åå‘ä»£ç†)

å¯é€‰æœåŠ¡ï¼š
- Vector DB (å‘é‡æ•°æ®åº“ï¼Œç”¨äº RAG)
- Worker (å¼‚æ­¥ä»»åŠ¡å¤„ç†)
```

---

## è¯¦ç»†æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤ 1ï¼šç®€åŒ– Docker Compose é…ç½®

#### 1.1 ä¸»é…ç½®æ–‡ä»¶

**`docker/docker-compose.yml`**
```yaml
version: '3.8'

# ç½‘ç»œé…ç½®
networks:
  shadow-network:
    driver: bridge

# æ•°æ®å·é…ç½®
volumes:
  postgres-data:
  redis-data:
  storage-data:

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: shadow-postgres
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      POSTGRES_DB: ${DB_DATABASE:-shadow_agents}
      POSTGRES_USER: ${DB_USERNAME:-shadow}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-shadow123456}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-shadow}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: shadow-redis
    restart: unless-stopped
    networks:
      - shadow-network
    command: redis-server --requirepass ${REDIS_PASSWORD:-shadow123456} --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API åç«¯æœåŠ¡
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: shadow-api
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      # æ•°æ®åº“é…ç½®
      DB_USERNAME: ${DB_USERNAME:-shadow}
      DB_PASSWORD: ${DB_PASSWORD:-shadow123456}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-shadow_agents}
      # Redis é…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-shadow123456}
      # åº”ç”¨é…ç½®
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      FLASK_ENV: ${FLASK_ENV:-production}
      DEBUG: ${DEBUG:-false}
      # CORS é…ç½®
      CORS_ALLOW_ORIGINS: ${CORS_ALLOW_ORIGINS:-*}
    volumes:
      - storage-data:/app/storage
      - ../api:/app
    ports:
      - "${API_PORT:-5001}:5001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: gunicorn --bind 0.0.0.0:5001 --workers 2 --timeout 120 app:app

  # Worker æœåŠ¡ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼Œå¯é€‰ï¼‰
  worker:
    build:
      context: ../api
      dockerfile: Dockerfile
    container_name: shadow-worker
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      # æ•°æ®åº“é…ç½®
      DB_USERNAME: ${DB_USERNAME:-shadow}
      DB_PASSWORD: ${DB_PASSWORD:-shadow123456}
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: ${DB_DATABASE:-shadow_agents}
      # Redis é…ç½®
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-shadow123456}
      # åº”ç”¨é…ç½®
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
    volumes:
      - storage-data:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.celery worker --loglevel=info
    profiles:
      - full  # åªåœ¨ full profile ä¸‹å¯åŠ¨

  # Web å‰ç«¯æœåŠ¡
  web:
    build:
      context: ../web
      dockerfile: Dockerfile
    container_name: shadow-web
    restart: unless-stopped
    networks:
      - shadow-network
    environment:
      NEXT_PUBLIC_API_URL: ${API_URL:-http://localhost/api}
      NEXT_PUBLIC_APP_NAME: ${APP_NAME:-Shadow Agents Platform}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - api

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: shadow-nginx
    restart: unless-stopped
    networks:
      - shadow-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    ports:
      - "${NGINX_PORT:-80}:80"
    depends_on:
      - api
      - web
```

#### 1.2 ç¯å¢ƒå˜é‡é…ç½®

**`docker/.env.example`**
```env
# ================================
# Shadow Agents Platform é…ç½®æ–‡ä»¶
# ================================

# åº”ç”¨ä¿¡æ¯
APP_NAME=Shadow Agents Platform
APP_VERSION=0.1.0

# æ•°æ®åº“é…ç½®
DB_USERNAME=shadow
DB_PASSWORD=shadow123456
DB_DATABASE=shadow_agents
DB_PORT=5432

# Redis é…ç½®
REDIS_PASSWORD=shadow123456
REDIS_PORT=6379

# åº”ç”¨å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒè¯·åŠ¡å¿…ä¿®æ”¹ï¼ï¼‰
SECRET_KEY=change-this-secret-key-in-production

# Flask ç¯å¢ƒ
FLASK_ENV=production
DEBUG=false

# API é…ç½®
API_PORT=5001
API_URL=http://localhost/api

# Web é…ç½®
WEB_PORT=3000

# Nginx é…ç½®
NGINX_PORT=80

# CORS é…ç½®
CORS_ALLOW_ORIGINS=*

# ================================
# å¯é€‰é…ç½®ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰
# ================================

# æ•°æ®åº“è¿æ¥æ± é…ç½®
SQLALCHEMY_POOL_SIZE=30
SQLALCHEMY_MAX_OVERFLOW=10

# JWT é…ç½®
JWT_ACCESS_TOKEN_EXPIRES=3600
JWT_REFRESH_TOKEN_EXPIRES=2592000

# æ–‡ä»¶å­˜å‚¨é…ç½®
STORAGE_TYPE=local
STORAGE_LOCAL_PATH=./storage
```

---

### æ­¥éª¤ 2ï¼šåˆ›å»º Dockerfile

#### 2.1 API Dockerfile

**`api/Dockerfile`**
```dockerfile
# ==============================
# Shadow Agents Platform - API
# ==============================

FROM python:3.11-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY pyproject.toml ./

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -e .

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºå­˜å‚¨ç›®å½•
RUN mkdir -p storage

# æš´éœ²ç«¯å£
EXPOSE 5001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:5001/health || exit 1

# å¯åŠ¨å‘½ä»¤ï¼ˆåœ¨ docker-compose ä¸­è¦†ç›–ï¼‰
CMD ["gunicorn", "--bind", "0.0.0.0:5001", "--workers", "2", "--timeout", "120", "app:app"]
```

#### 2.2 Web Dockerfile

**`web/Dockerfile`**
```dockerfile
# ==============================
# Shadow Agents Platform - Web
# ==============================

FROM node:18-alpine AS base

# å®‰è£…ä¾èµ–é˜¶æ®µ
FROM base AS deps
WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json* ./
RUN npm ci

# æ„å»ºé˜¶æ®µ
FROM base AS builder
WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# å¯åŠ¨å‘½ä»¤
CMD ["node", "server.js"]
```

---

### æ­¥éª¤ 3ï¼šNginx é…ç½®

#### 3.1 ä¸»é…ç½®æ–‡ä»¶

**`docker/nginx/nginx.conf`**
```nginx
# Shadow Agents Platform - Nginx é…ç½®

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript application/xml+rss 
               application/rss+xml font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;

    # åŒ…å«ç«™ç‚¹é…ç½®
    include /etc/nginx/conf.d/*.conf;
}
```

#### 3.2 ç«™ç‚¹é…ç½®

**`docker/nginx/conf.d/default.conf`**
```nginx
# Shadow Agents Platform - ç«™ç‚¹é…ç½®

# API ä¸Šæ¸¸æœåŠ¡å™¨
upstream api_backend {
    server api:5001;
}

# Web ä¸Šæ¸¸æœåŠ¡å™¨
upstream web_backend {
    server web:3000;
}

server {
    listen 80;
    server_name _;

    # å®¢æˆ·ç«¯è¯·æ±‚ä½“å¤§å°é™åˆ¶
    client_max_body_size 100M;

    # API è·¯ç”±
    location /api/ {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # Web å‰ç«¯è·¯ç”±
    location / {
        proxy_pass http://web_backend;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
```

---

### æ­¥éª¤ 4ï¼šåˆ›å»ºéƒ¨ç½²è„šæœ¬

#### 4.1 ä¸€é”®å¯åŠ¨è„šæœ¬

**`docker/start.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform å¯åŠ¨è„šæœ¬
# ====================================

set -e

echo "========================================="
echo "  Shadow Agents Platform"
echo "  æ­£åœ¨å¯åŠ¨..."
echo "========================================="

# æ£€æŸ¥ Docker å’Œ Docker Compose
if ! command -v docker &> /dev/null; then
    echo "é”™è¯¯: æœªå®‰è£… Docker"
    exit 1
fi

if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "é”™è¯¯: æœªå®‰è£… Docker Compose"
    exit 1
fi

# è¿›å…¥è„šæœ¬æ‰€åœ¨ç›®å½•
cd "$(dirname "$0")"

# æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
if [ ! -f ".env" ]; then
    echo "æœªæ‰¾åˆ° .env æ–‡ä»¶ï¼Œä»ç¤ºä¾‹åˆ›å»º..."
    cp .env.example .env
    echo "âœ“ å·²åˆ›å»º .env æ–‡ä»¶"
    echo ""
    echo "è­¦å‘Š: è¯·ä¿®æ”¹ .env æ–‡ä»¶ä¸­çš„å¯†é’¥é…ç½®ï¼"
    echo "ç‰¹åˆ«æ˜¯ SECRET_KEYã€DB_PASSWORD å’Œ REDIS_PASSWORD"
    echo ""
fi

# é€‰æ‹©éƒ¨ç½²æ¨¡å¼
echo "é€‰æ‹©éƒ¨ç½²æ¨¡å¼:"
echo "1) æ ‡å‡†æ¨¡å¼ (API + Web + æ•°æ®åº“)"
echo "2) å®Œæ•´æ¨¡å¼ (åŒ…å« Worker å¼‚æ­¥ä»»åŠ¡)"
read -p "è¯·é€‰æ‹© [1/2]: " mode

case $mode in
    2)
        echo "å¯åŠ¨å®Œæ•´æ¨¡å¼..."
        docker-compose --profile full up -d
        ;;
    *)
        echo "å¯åŠ¨æ ‡å‡†æ¨¡å¼..."
        docker-compose up -d
        ;;
esac

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo ""
echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 5

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo ""
echo "========================================="
echo "  æœåŠ¡çŠ¶æ€"
echo "========================================="
docker-compose ps

# æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
echo ""
echo "========================================="
echo "  éƒ¨ç½²å®Œæˆï¼"
echo "========================================="
echo ""
echo "è®¿é—®åœ°å€:"
echo "  - å‰ç«¯: http://localhost"
echo "  - API:  http://localhost/api"
echo ""
echo "é»˜è®¤ç«¯å£:"
echo "  - Nginx:      80"
echo "  - API:        5001"
echo "  - Web:        3000"
echo "  - PostgreSQL: 5432"
echo "  - Redis:      6379"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—: docker-compose logs -f"
echo "åœæ­¢æœåŠ¡: docker-compose down"
echo ""
```

#### 4.2 åœæ­¢è„šæœ¬

**`docker/stop.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform åœæ­¢è„šæœ¬
# ====================================

set -e

cd "$(dirname "$0")"

echo "æ­£åœ¨åœæ­¢ Shadow Agents Platform..."

docker-compose down

echo "æœåŠ¡å·²åœæ­¢"
```

#### 4.3 é‡å¯è„šæœ¬

**`docker/restart.sh`**
```bash
#!/bin/bash

# ====================================
# Shadow Agents Platform é‡å¯è„šæœ¬
# ====================================

set -e

cd "$(dirname "$0")"

echo "æ­£åœ¨é‡å¯ Shadow Agents Platform..."

docker-compose restart

echo "æœåŠ¡å·²é‡å¯"
```

#### 4.4 ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™

```bash
chmod +x docker/start.sh
chmod +x docker/stop.sh
chmod +x docker/restart.sh
```

---

### æ­¥éª¤ 5ï¼šæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

**`docker/postgres/init.sql`**
```sql
-- ====================================
-- Shadow Agents Platform
-- æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
-- ====================================

-- åˆ›å»ºå¿…è¦çš„æ‰©å±•
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- è®¾ç½®æ—¶åŒº
SET timezone = 'UTC';

-- åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
-- æ³¨æ„: Docker å·²é€šè¿‡ç¯å¢ƒå˜é‡åˆ›å»ºæ•°æ®åº“ï¼Œæ­¤å¤„ä¸ºå¤‡ç”¨

-- è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
SELECT version();

-- å®Œæˆ
\echo 'æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ'
```

---

### æ­¥éª¤ 6ï¼šåˆ›å»ºéƒ¨ç½²æ–‡æ¡£

**`docs/guides/deployment.md`**
````markdown
# éƒ¨ç½²æŒ‡å—

Shadow Agents Platform æä¾›äº†ç®€åŒ–çš„ Docker éƒ¨ç½²æ–¹æ¡ˆï¼Œæ”¯æŒå¿«é€Ÿå¯åŠ¨å’Œè¿ç»´ã€‚

---

## ç³»ç»Ÿè¦æ±‚

### æœ€ä½é…ç½®
- CPU: 2 æ ¸å¿ƒ
- å†…å­˜: 4GB RAM
- ç£ç›˜: 20GB å¯ç”¨ç©ºé—´
- æ“ä½œç³»ç»Ÿ: Linux / macOS / Windows (with WSL2)

### æ¨èé…ç½®
- CPU: 4 æ ¸å¿ƒ
- å†…å­˜: 8GB RAM
- ç£ç›˜: 50GB å¯ç”¨ç©ºé—´

### è½¯ä»¶è¦æ±‚
- Docker 20.10+
- Docker Compose 2.0+

---

## å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†ä»“åº“

```bash
git clone https://github.com/your-org/shadow-agents-platform.git
cd shadow-agents-platform
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
cd docker
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œè‡³å°‘ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```env
# åº”ç”¨å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰
SECRET_KEY=your-secret-key-here

# æ•°æ®åº“å¯†ç 
DB_PASSWORD=your-secure-password

# Redis å¯†ç 
REDIS_PASSWORD=your-secure-password
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨ä¸€é”®å¯åŠ¨è„šæœ¬
./start.sh

# æˆ–æ‰‹åŠ¨å¯åŠ¨
docker-compose up -d
```

### 4. è®¿é—®åº”ç”¨

æ‰“å¼€æµè§ˆå™¨è®¿é—®: http://localhost

é»˜è®¤ä¼šè¿›å…¥å®‰è£…å‘å¯¼ï¼ŒæŒ‰æç¤ºåˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ã€‚

---

## éƒ¨ç½²æ¨¡å¼

### æ ‡å‡†æ¨¡å¼ï¼ˆæ¨èï¼‰

åŒ…å«æ ¸å¿ƒæœåŠ¡ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼š

```bash
docker-compose up -d
```

æœåŠ¡åˆ—è¡¨ï¼š
- API (åç«¯)
- Web (å‰ç«¯)
- PostgreSQL (æ•°æ®åº“)
- Redis (ç¼“å­˜)
- Nginx (åå‘ä»£ç†)

### å®Œæ•´æ¨¡å¼

åŒ…å«æ‰€æœ‰æœåŠ¡ï¼Œæ”¯æŒå¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼š

```bash
docker-compose --profile full up -d
```

é¢å¤–æœåŠ¡ï¼š
- Worker (Celery å¼‚æ­¥ä»»åŠ¡)

---

## å¸¸ç”¨å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f api
docker-compose logs -f web
```

### åœæ­¢æœåŠ¡

```bash
docker-compose down
```

### é‡å¯æœåŠ¡

```bash
docker-compose restart
```

### æ›´æ–°æœåŠ¡

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build
```

---

## æ•°æ®å¤‡ä»½

### å¤‡ä»½æ•°æ®åº“

```bash
docker exec shadow-postgres pg_dump -U shadow shadow_agents > backup.sql
```

### æ¢å¤æ•°æ®åº“

```bash
docker exec -i shadow-postgres psql -U shadow shadow_agents < backup.sql
```

### å¤‡ä»½æ–‡ä»¶å­˜å‚¨

```bash
docker run --rm -v shadow-agents-platform_storage-data:/data -v $(pwd):/backup alpine tar czf /backup/storage-backup.tar.gz /data
```

---

## æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

1. æ£€æŸ¥ç«¯å£å ç”¨ï¼š
```bash
netstat -tulpn | grep -E '80|3000|5001|5432|6379'
```

2. æ£€æŸ¥ Docker èµ„æºï¼š
```bash
docker system df
```

3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼š
```bash
docker-compose logs
```

### æ•°æ®åº“è¿æ¥å¤±è´¥

1. æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€ï¼š
```bash
docker-compose ps postgres
```

2. æµ‹è¯•æ•°æ®åº“è¿æ¥ï¼š
```bash
docker exec shadow-postgres pg_isready -U shadow
```

### API æ— å“åº”

1. æ£€æŸ¥ API æ—¥å¿—ï¼š
```bash
docker-compose logs api
```

2. è¿›å…¥å®¹å™¨è°ƒè¯•ï¼š
```bash
docker exec -it shadow-api bash
```

---

## ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 1. ä½¿ç”¨ HTTPS

é…ç½® SSL è¯ä¹¦ï¼Œä½¿ç”¨ Let's Encryptï¼š

```bash
# å®‰è£… certbot
apt-get install certbot

# è·å–è¯ä¹¦
certbot certonly --standalone -d yourdomain.com
```

æ›´æ–° Nginx é…ç½®ä»¥æ”¯æŒ HTTPSã€‚

### 2. ä¿®æ”¹é»˜è®¤å¯†ç 

ç¡®ä¿ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç ï¼š
- SECRET_KEY
- DB_PASSWORD
- REDIS_PASSWORD

### 3. å¯ç”¨é˜²ç«å¢™

```bash
# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 4. å®šæœŸå¤‡ä»½

è®¾ç½®å®šæ—¶ä»»åŠ¡å¤‡ä»½æ•°æ®åº“å’Œæ–‡ä»¶ã€‚

### 5. èµ„æºç›‘æ§

ä½¿ç”¨å·¥å…·ç›‘æ§æœåŠ¡çŠ¶æ€ï¼š
- Docker stats
- Prometheus + Grafana
- äº‘æœåŠ¡å•†ç›‘æ§

---

## å‡çº§æŒ‡å—

### å°ç‰ˆæœ¬å‡çº§

```bash
git pull
docker-compose up -d --build
```

### å¤§ç‰ˆæœ¬å‡çº§

1. å¤‡ä»½æ•°æ®
2. æŸ¥çœ‹æ›´æ–°æ—¥å¿— (CHANGELOG.md)
3. æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆå¦‚æœ‰ï¼‰
4. æ›´æ–°é…ç½®æ–‡ä»¶
5. é‡æ–°æ„å»ºå’Œå¯åŠ¨

---

## è·å–å¸®åŠ©

- æŸ¥çœ‹æ–‡æ¡£: `docs/`
- æäº¤ Issue: GitHub Issues
- ç¤¾åŒºè®¨è®º: GitHub Discussions

---
````

---

## ç®€åŒ–å¯¹æ¯”

### Dify åŸé…ç½®
- 1375 è¡Œ Docker Compose é…ç½®
- 100+ ç¯å¢ƒå˜é‡
- å¤šä¸ªå¯é€‰ä¸­é—´ä»¶ï¼ˆElasticsearchã€å‘é‡æ•°æ®åº“ç­‰ï¼‰
- å¤æ‚çš„ç½‘ç»œå’Œå·é…ç½®

### Shadow ç®€åŒ–ç‰ˆ
- ~200 è¡Œ Docker Compose é…ç½®
- ~30 ä¸ªæ ¸å¿ƒç¯å¢ƒå˜é‡
- åªä¿ç•™å¿…éœ€æœåŠ¡
- é¢„è®¾åˆç†é»˜è®¤å€¼
- æä¾›ä¸€é”®å¯åŠ¨è„šæœ¬

---

## éªŒè¯æ£€æŸ¥æ¸…å•

- [ ] Docker Compose é…ç½®è¯­æ³•æ­£ç¡®
- [ ] ç¯å¢ƒå˜é‡é…ç½®å®Œæ•´
- [ ] Dockerfile æ„å»ºæˆåŠŸ
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] å¯åŠ¨è„šæœ¬å¯æ‰§è¡Œ
- [ ] æœåŠ¡å¥åº·æ£€æŸ¥æœ‰æ•ˆ
- [ ] æ•°æ®æŒä¹…åŒ–æ­£å¸¸
- [ ] éƒ¨ç½²æ–‡æ¡£æ¸…æ™°

---

## ä¸‹ä¸€æ­¥

å®Œæˆéƒ¨ç½²é…ç½®åï¼Œè¿›å…¥ï¼š
ğŸ‘‰ **é˜¶æ®µå…­ï¼šç§»é™¤ä½œè€…ä¿¡æ¯å’Œå“ç‰Œå…ƒç´ **
